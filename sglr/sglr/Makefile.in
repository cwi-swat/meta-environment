# $Id$
# Directory: sglr/src

# Configure variable substitutions
PRODUCT		= @PRODUCT@
VERSION		= @VERSION@

@SET_MAKE@
VPATH		= @srcdir@
srcdir		= @srcdir@
top_srcdir	= @top_srcdir@
prefix		= @prefix@
exec_prefix	= @exec_prefix@
bindir		= ${exec_prefix}/bin
libdir		= ${exec_prefix}/lib
includedir	= ${prefix}/include
docdir		= ${top_srcdir}/docs

SHELL		= @SHELL@

AR              = @AR@
AR_FLAGS        = cr

CC		= @CC@
CFLAGS		= @CFLAGS@ ${XCFLAGS}
CFLAGSPROF	= -pg ${CFLAGS}
CPP		= @CPP@
CPPFLAGS	= @CPP@ ${XCPPFLAGS}
LDFLAGS         = -g
LDFLAGSPROF     = ${LDFLAGS} -pg

MAKE		= gmake

DEFS		= @DEFS@ # -DDEBUG # -O2 -funroll-loops 
INCLUDES	= @INCLUDES@ ${XINCLUDES}
LIBSALL		= @LIBS@ ${SOCKLIBS} -L${libdir}
LIBS		= ${LIBSALL} ${XLIBS}
LIBSPROF	= ${LIBSALL} ${XLIBSPROF}
SOCKLIBS	= @SOCKLIBS@

INSTALL		= @INSTALL@
INSTALL_DATA	= @INSTALL_DATA@
INSTALL_PROG	= @INSTALL_PROG@
UNINSTALL	= @UNINSTALL@

ATERM           = @ATERM@
TOOLBUS         = @TOOLBUS@

# The eXtra parts of some variables
XCFLAGS		= ${DEFS}
XA2TOA1CFLAG	= -DHAVE_A2TOA1
XA2TOA1LIB	= -la2toa1
XGCCFLAG	= -DHAVE_BOEHMGC
XGCLIB		= -lgc
XA2TOA1GCCFLAG	= ${XA2TOA1CFLAG} ${XGCCFLAG}
XA2TOA1GCLIB	= ${XA2TOA1LIB} ${XGCLIB}
XINCLUDES	= -I${ATERM}/include
ATVERS		= ${CC}
#ATVERS		= dbg
XLIBS		= -lATerm-${ATVERS} -lAsFix-${ATVERS} -lATB-${ATVERS}
XLIBSPROF	= -lATerm-prof  -lAsFix-prof  -lATB-prof

SGLRLIB         = libsglr.a
SGLRLIBA2TOA1   = libsglr-a2toa1.a
SGLRLIBGC       = libsglr-gc.a
SGLRLIBA2TOA1GC = libsglr-a2toa1-gc.a
SGLRLIBPROF     = libsglr-prof.a
SGLRLIBS        = ${SGLRLIB} ${SGLRLIBA2TOA1} ${SGLRLIBGC} ${SGLRLIBPROF}
SGLRINC         = sglr.h
LIBSRC          = sglr-interface.c parse-table.c parser.c forest.c stack.c tree-to-dot.c
LIBOBJ          = ${patsubst %.c,%.o,${LIBSRC}}
LIBOBJA2TOA1    = ${patsubst %.c,%-a2toa1.o,${LIBSRC}}
LIBOBJGC        = ${patsubst %.c,%-gc.o,${LIBSRC}}
LIBOBJA2TOA1GC  = ${patsubst %.c,%-a2toa1-gc.o,${LIBSRC}}
LIBOBJPROF      = ${patsubst %.c,%-prof.o,${LIBSRC}}

PROG            = sglr ${CLIENT} ${DUMP}
PROGS           = ${PROG} sglr-a2toa1 sglr-gc sglr-a2toa1-gc sglr-prof
CLIENT		= parse-client
CLIENTC		= ${addsuffix .c,${CLIENT}}
TIFS		= sglr.tif.c parse-client.tif.c
DUMP		= dump-actions dump-gotos dump-priorities dump-productions
DUMPC		= dump-parse-table.c
PROGS           = ${PROG} sglr-a2toa1 sglr-gc sglr-a2toa1-gc sglr-prof
PUREPROGS       = ${addsuffix .pure,${PROG}}
GETOPTC         = getopt.c getopt1.c
GETOPTOBJ       = ${patsubst %.c,%.o,${GETOPTC}}
CSRC            = sglr-main.c
OBJ             = ${patsubst %.c,%.o,${CSRC}}
OBJA2TOA1       = ${patsubst %.c,%-a2toa1.o,${CSRC}}

all:	${PROG}

.SILENT:	depend

pure:	${PUREPROGS}

complete:	${PROGS} ${PUREPROGS}

install:	incinstall libinstall bininstall

incinstall:	${SGLRINC}
	@for INC in ${SGLRINC};	\
	do \
		${INSTALL_DATA} ${INSTALL} ${includedir} $$INC; \
	done

libinstall:	${SGLRLIB}
	@for LIB in ${SGLRLIB};	\
	do \
		${INSTALL_DATA} ${INSTALL} ${libdir} $$LIB; \
	done

bininstall:	${PROG}
	@for PROG in ${PROG};	\
	do \
		${INSTALL_PROG} ${INSTALL} ${bindir} $$PROG; \
	done

distclean realclean spotless:	clean
	rm -f	 ${GETOPTOBJ} ${SGLRLIBS} ${PROGS} ${PUREPROGS} Makefile

clean:
	rm -f	core depend sglr.tifs sglr.tif.[ch]
	rm -f	parse-client.tifs parse-client.tif.[ch]
	rm -f	${PROGS}
	rm -f	${PUREPROGS}
	rm -f	${SGLRLIBS}
	rm -f	${OBJ} ${OBJA2TOA1}
	rm -f	${LIBOBJ}
	rm -f	${LIBOBJA2TOA1}
	rm -f	${LIBOBJGC}
	rm -f	${LIBOBJA2TOA1GC}
	rm -f	${LIBOBJPROF}

# Generic rules

%.pure:	%
	purify $<

%-a2toa1.o:	%.c
	${CC} ${CFLAGS} ${XA2TOA1CFLAG} ${INCLUDES} -c $< -o $@

%-gc.o:	%.c
	${CC} ${CFLAGS} ${XGCCFLAG} ${INCLUDES} -c $< -o $@

%-a2toa1-gc.o:	%.c
	${CC} ${CFLAGS} ${XA2TOA1GCCFLAG} ${INCLUDES} -c $< -o $@

%-prof.o:	%.c
	${CC} ${CFLAGSPROF} ${INCLUDES} -c $< -o $@

%.o:	%.c
	${CC} ${CFLAGS} ${INCLUDES} -c $<

%.tif.c: %.tifs
	${prefix}/bin/tifstoc -tool $* $<

%.tifs: %.tb
	${prefix}/bin/toolbus -gentifs $<


# Specific dependencies

libsglr.a:  ${LIBOBJ}
	${AR} ${AR_FLAGS} $@ ${LIBOBJ}

libsglr-a2toa1.a:  ${LIBOBJA2TOA1}
	${AR} ${AR_FLAGS} $@ ${LIBOBJA2TOA1}

libsglr-gc.a:  ${LIBOBJGC}
	${AR} ${AR_FLAGS} $@ ${LIBOBJGC}

libsglr-a2toa1-gc.a:  ${LIBOBJA2TOA1GC}
	${AR} ${AR_FLAGS} $@ ${LIBOBJA2TOA1GC}

libsglr-prof.a:  ${LIBOBJPROF}
	${AR} ${AR_FLAGS} $@ ${LIBOBJPROF}

sglr: ${GETOPTOBJ} ${OBJ} ${SGLRLIB} sglr.tif.c
	${CC} ${LDFLAGS} ${OBJ} ${GETOPTOBJ} ${SGLRLIB} ${LIBS} -o $@

sglr-a2toa1: ${GETOPTOBJ} ${OBJA2TOA1} ${SGLRLIBA2TOA1} sglr.tif.c
	${CC} ${LDFLAGS} ${OBJA2TOA1} ${GETOPTOBJ}		\
		${SGLRLIBA2TOA1} ${XA2TOA1LIB} ${LIBS} -o $@

sglr-gc: ${GETOPTOBJ} ${OBJ} ${SGLRLIBGC} sglr.tif.c
	${CC} ${LDFLAGS} ${OBJ} ${GETOPTOBJ} ${SGLRLIBGC} ${XGCLIB} ${LIBS} -o $@

sglr-a2toa1-gc: ${GETOPTOBJ} ${OBJA2TOA1} ${SGLRLIBA2TOA1GC} sglr.tif.c
	${CC} ${LDFLAGS} ${OBJA2TOA1} ${GETOPTOBJ}		\
		${SGLRLIBA2TOA1GC} ${XA2TOA1GCLIB} ${LIBS} -o $@

sglr-prof: ${GETOPTOBJ} ${OBJ} ${SGLRLIBPROF} sglr.tif.c
	${CC} ${LDFLAGSPROF} ${OBJ} ${GETOPTOBJ} ${SGLRLIBPROF} ${LIBSPROF} -o $@

parse-client: ${GETOPTOBJ} parse-client.o parse-client.tif.c
	${CC} ${LDFLAGS} $@.o ${GETOPTOBJ} ${LIBS} -o $@

dump-actions dump-priorities	\
dump-gotos dump-productions:	${DUMPC} ${SGLRLIB}
	${CC}	${CFLAGS} ${INCLUDES} ${LDFLAGS}	\
		${DUMPC} -DPTPART=${subst dump-,,$@}	\
		${SGLRLIB} ${LIBS} -o $@	

# ObTribute to Larry Wall
love:
	@echo "not war"


# The GNU getopt sources ${GETOPTC} might not compile silently
# when using a high warning level in a really pedantic compiler

getopt.o: getopt.c
	${CC} -O3 -c $<

getopt1.o: getopt1.c
	${CC} -O3 -c $<

# Handle dependencies
depend: ${CSRC} ${LIBSRC} ${GETOPTC} ${CLIENTC} ${DUMPC} ${TIFS}
	makedepend ${INCLUDES} ${CSRC} ${GETOPTC}	 -f -	>	$@
	makedepend ${INCLUDES} ${CLIENTC} ${DUMPC} -f -		>>	$@
	makedepend ${INCLUDES} ${LIBSRC} -f -			>	$@.tmp
	cat	$@.tmp						>>	$@
	sed -e 's/^\([^ :]*\).o:/\1-a2toa1.o:/'	$@.tmp		>>	$@
	sed -e 's/^\([^ :]*\).o:/\1-gc.o:/'	$@.tmp		>>	$@
	sed -e 's/^\([^ :]*\).o:/\1-a2toa1-gc.o:/'	$@.tmp	>>	$@
	sed -e 's/^\([^ :]*\).o:/\1-prof.o:/'	$@.tmp		>>	$@
	@rm -f $@.tmp
#	@echo "Dependencies updated: you may have to ${MAKE} again."

-include depend

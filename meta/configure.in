toodnl $Id$

dnl Process this file with autoconf to produce a configure script.
AC_INIT

dnl Product name and version number
PRODUCT=new-meta
VERSION=0.02
NEW_META=`pwd`

AC_SUBST(PRODUCT)
AC_SUBST(VERSION)
AC_SUBST(NEW_META)

dnl Default locations of other components
dnl Default locations of used components
AC_PATH_PROG(TOOLBUS, toolbus, no)
if test "${TOOLBUS}" = "no"; then
	TOOLBUS='${prefix}'
else
	TOOLBUS=`dirname \`dirname ${TOOLBUS}\``
fi
AC_PATH_PROG(ATERM, tifstoc, no)
if test "${ATERM}" = "no"; then
	ATERM='${prefix}'
else
	ATERM=`dirname \`dirname ${ATERM}\``
fi

dnl Installation scripts
INSTALL='$(top_srcdir)/install-sh'
INSTALL_PROG='$(top_srcdir)/install-prog-sh'
INSTALL_DATA='$(top_srcdir)/install-data-sh'
UNINSTALL='$(top_srcdir)/uninstall-sh'
AC_SUBST(INSTALL)
AC_SUBST(INSTALL_PROG)
AC_SUBST(INSTALL_DATA)
AC_SUBST(UNINSTALL)

dnl Our own version of libdir iwhose value is set dynamically
AC_SUBST(INSTLIBDIR)
INSTLIBDIR="$libdir"

dnl Is ranlib needed on this system?
AC_PROG_RANLIB
AC_PATH_PROG(AR,ar,/usr/bin/ar)

AC_DEFUN(AC_PROG_MAKEDEPEND, [
AC_CHECK_PROGS(MAKEDEP, gccmakedep makedepend, no)
AC_REQUIRE([AC_PROG_CC])
AC_MSG_CHECKING([how to generate dependencies])
AC_CACHE_VAL(ac_cv_prog_MAKEDEPEND,
if test "${GCC}" = "yes"; then
	ac_cv_prog_MAKEDEPEND="${CC-cc} -MM"
else
	ac_cv_prog_MAKEDEPEND="$MAKEDEP -f-"
fi
)
MAKEDEPEND=$ac_cv_prog_MAKEDEPEND
AC_MSG_RESULT([${ac_cv_prog_MAKEDEPEND}])
AC_SUBST([MAKEDEPEND])
])dnl

dnl Which compiler to use?
AC_PROG_CC
dnl Which makedepend to use?
AC_PROG_MAKEDEPEND
dnl If anyone knows why this is used...
AC_AIX

dnl Where to locate a bourne-compatible shell?
SHELL='/bin/sh'
AC_SUBST(SHELL)

dnl Where is perl5?
AC_PATH_PROGS(PERL,perl5 perl, /usr/bin/perl)

dnl What commands are needed to set the variable MAKE in Makefiles?
AC_SET_MAKE

dnl Which CFLAGS to use?
if test "${GCC}" = "yes" ; then
	CFLAGS="-g -Wall -O4"
fi
AC_SUBST(CFLAGS)
AC_SUBST(DEFS)
AC_SUBST(INCLUDES)

dnl Handle --with-aterm=... argument to configure
AC_ARG_WITH(aterm,
[  --with-aterm=DIR        ATerm-library is in DIR],
ATERM=${withval},)
AC_SUBST(ATERM)
AC_ARG_WITH(aterm-bin,
[  --with-aterm-bin=DIR    ATerm executables are in DIR],
ATERMBIN=${withval},ATERMBIN=${ATERM}/bin)
AC_SUBST(ATERMBIN)
AC_ARG_WITH(aterm-lib,
[  --with-aterm-lib=DIR    ATerm libraries are in DIR],
ATERMLIB=${withval},ATERMLIB=${ATERM}/lib)
AC_SUBST(ATERMLIB)
AC_ARG_WITH(aterm-inc,
[  --with-aterm-inc=DIR    ATerm header files are in DIR],
ATERMINC=${withval},ATERMINC=${ATERM}/include)
AC_SUBST(ATERMINC)

dnl Handle --with-toolbus[-...]=... arguments to configure
AC_ARG_WITH(toolbus,
[  --with-toolbus=DIR      ToolBus distribution is in DIR],
TOOLBUS=${withval},)
AC_SUBST(TOOLBUS)
AC_ARG_WITH(toolbus-bin,
[  --with-toolbus-bin=DIR  ToolBus executables are in DIR],
TOOLBUSBIN=${withval},TOOLBUSBIN=${TOOLBUS}/bin)
AC_SUBST(TOOLBUSBIN)
AC_ARG_WITH(toolbus-lib,
[  --with-toolbus-lib=DIR  ToolBus libraries are in DIR],
TOOLBUSLIB=${withval},TOOLBUSLIB=${TOOLBUS}/lib)
AC_SUBST(TOOLBUSLIB)
AC_ARG_WITH(toolbus-inc,
[  --with-toolbus-inc=DIR  ToolBus header files are in DIR],
TOOLBUSINC=${withval},TOOLBUSINC=${TOOLBUS}/include)
AC_SUBST(TOOLBUSINC)

dnl Handle --with-tcldot=... argument to configure
AC_ARG_WITH(tcldot,
[  --with-tcldot=DIR       TclDot library is in DIR],
TCLDOT=${withval},
AC_MSG_ERROR(\nPlease specify location of tcldot using --with-tcldot=/path/to/tcldot.so\nIf you are at CWI/UvA a good guess would be ~gipe/petr/lib/Tcldot)
)
AC_SUBST(TCLDOT)

dnl Of course, the latest version of wish is not always called "wish". :-(
dnl If we can't find something called wish8.1 or wish8.0, we'll assume
dnl that "wish" is at version 8 or higher (as it is in a _normal_ setup)
AC_PATH_PROGS(WISH,wish8.1 wish8.0 wish, /usr/bin/wish)

dnl Determine which libraries to use for programs using sockets
NOSOCKLIBS=$LIBS
dnl first, the socket functions
SOCKET_FOUND=no
SOCKLIBS=
AC_CHECK_LIB(sun,socket,[SOCKET_FOUND=yes;SOCKLIBS="-lsun"])
if test ${SOCKET_FOUND} = no; then
  AC_CHECK_LIB(socket, socket,[SOCKET_FOUND=yes;SOCKLIBS="-lsocket"])
  if test ${SOCKET_FOUND} = no; then
    AC_CHECK_LIB(bsd,socket,[SOCKET_FOUND=yes;SOCKLIBS="-lbsd";DEFS="$DEFS -D_BSD=43"])
  fi
fi

dnl then gethostname
GHN_FOUND=no
AC_CHECK_LIB(sun,gethostname,[GHN_FOUND=yes])
if test ${GHN_FOUND} = no; then
  AC_CHECK_LIB(nsl,gethostname,[GHN_FOUND=yes;SOCKLIBS="$SOCKLIBS -lnsl"])
fi

LIBS=$NOSOCKLIBS
AC_CHECK_LIB(dl, dlopen)

dnl Checks for header files.
AC_CHECK_HEADER(getopt.h)

AC_SUBST(SOCKLIBS)

dnl Handle subpackages...
AC_CONFIG_SUBDIRS(asc-support sglr pgen)

dnl Which files need updating?
AC_OUTPUT(
	Makefile Makefile.skel meta \
	asource/Makefile \
	compiler/Makefile compiler/c-source/Makefile \
	editor/Makefile editor/editor \
	evaluator/Makefile \
	graph-browser/Makefile graph-browser/graph-browser \
	in-output/Makefile \
	module-db/Makefile \
	stred/nl/cwi/gipe/stred/Makefile \
	toolbus/Makefile toolbus/edit-module.tb \
	toolbus/open-modules.tb toolbus/revert-module.tb \
	toolbus/help.tb \
        utils/Makefile utils/genmakefile.sh utils/gen-table \
        utils/normalize-sdf utils/parse-sdf2  utils/parse-file \
        utils/ps-dot utils/sdf2table \
  , chmod +x meta install-prog-sh install-data-sh; \
    chmod +x graph-browser/graph-browser editor/editor; \
    chmod +x utils/gen-table utils/normalize-sdf \
             utils/parse-sdf2 utils/ps-dot utils/sdf2table 
)

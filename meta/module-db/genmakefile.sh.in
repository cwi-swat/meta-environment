#! @SHELL@
#
# $Id$
#   Date: 3/19/1998
# Author: Merijn de Jonge, Jeroen Scheerder
#
# This script generates both a Makefile.in for use with autconf as well
# as a Makefile suitable for compiling the C code corresponding to a 
# compiled specification.
#
# usage:
#    genmakefile.sh <target>
#
# where <target> is the name of the desired stand-alone executable program.
#
# The generated Makefile understands the following targets:
#
# all, or <target>        This will build <target>
# install                 Builds and installs <target>
# debug                   This will build <target>-db (i.e., a
#                         stand-alone program suitable for debugging)
# profile                 This will build <target>-prof (i.e., a
#                         stand-alone program suitable for profiling)
# clean                   This will remove <target>, <target>-db
#                         <target>-prof, *.o init.c
#

## No changes below

PERL=@PERL@
srcdir=@srcdir@
top_srcdir=@top_srcdir@
prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
libdir=@libdir@
PROTO=${libdir}/genmakefile.proto

# display usage message
usage()
{
   cat<<ENDCAT
$0
   generates on standard output a Makefile for the compilation of the
   C code corresponding to a compiled specification.

usage:
$0 [-h] <target>
   where <target> is the name of the desired stand-alone executable program.

ENDCAT
}


# parse command line
if [ $# -ne 1 ]
then
   usage
   exit 1
fi

if [ $1 = "-h" -o $1 = "-help" ]
then
   usage
   exit 0
fi

if [ ! -r $1.module-list ]
then
   echo "Could not find module list \"$1.module-list\"" >&2
   exit 1
fi

#
# Create the configure-ready Makefile.in template
#

cat <<HDR					> Makefile.in
#
# Makefile.in for target "$1 generated automagically on `date`
#
HDR
cat ${PROTO} |
	$PERL -pe "s|\@TARGET\@|$1|g"		|
	$PERL -pe 's|%!%([^@]+)%!%|\@$1\@|g'	>> Makefile.in

# Create the instantiated Makefile, by substituting configure's
# variables `manually'.  Beware: to prevent perl from interfering (by
# interpolating configure variable values) the configure items must be
# quoted sans interpolation explicitly before substitution.
#
cat <<HDR					> Makefile
#
# Makefile.in for target "$1 generated automagically on `date`
#
HDR
cat ${PROTO} |
	$PERL -pe '
		$srcdir   = q{@srcdir@};
		$topsrc   = q{@top_srcdir@};
		$CC       = q{@CC@};
		$prefix   = q{@prefix@};
		$eprefix  = q{@exec_prefix@};
		$bindir   = q{@bindir@};
		$libdir   = q{@libdir@};
		$incdir   = q{@includedir@};
		$DEFS     = q{@DEFS@};
		$INCLUDES = q{@INCLUDES@};
		$LIBS     = q{@LIBS@};
		$SOCKLIBS = q{@SOCKLIBS@};
		$INSTALL  = q{@INSTALL@};
		$INSTDATA = q{@INSTALL_DATA@};
		$INSTPROG = q{@INSTALL_PROG@};
		$UNINSTALL= q{@UNINSTALL@};
		$ATERM    = q{@ATERM@};

		s|%!%srcdir%!%|$srcdir|g;
		s|%!%top_srcdir%!%|$topsrc|g;
		s|%!%CC%!%|$CC|g;
		s|%!%prefix%!%|$prefix|g;
		s|%!%exec_prefix%!%|$eprefix|g;
		s|%!%bindir%!%|$bindir|g;
		s|%!%libdir%!%|$libdir|g;
		s|%!%includedir%!%|$incdir|g;
		s|%!%DEFS%!%|$DEFS|g;
		s|%!%INCLUDES%!%|$INCLUDES|g;
		s|%!%LIBS%!%|$LIBS|g;
		s|%!%SOCKLIBS%!%|$SOCKLIBS|g;
		s|%!%INSTALL%!%|$INSTALL|g;
		s|%!%INSTALL_DATA%!%|$INSTDATA|g;
		s|%!%INSTALL_PROG%!%|$INSTPROG|g;
		s|%!%UNINSTALL%!%|$UNINSTALL|g;
		s|%!%ATERM%!%|$ATERM|g;'	>> Makefile

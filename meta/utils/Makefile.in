#
#    Meta-Environment - An environment for language prototyping.
#    Copyright (C) 2000  Stichting Mathematisch Centrum, Amsterdam, The Netherlands. 
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program; if not, write to the Free Software
#    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
#
# $Id$

# Configure variable substitutions
PRODUCT		= @PRODUCT@
VERSION		= @VERSION@

@SET_MAKE@

srcdir		= @srcdir@
VPATH		= @srcdir@
top_srcdir	= @top_srcdir@
prefix		= @prefix@
exec_prefix	= @exec_prefix@
bindir		= @bindir@
libdir		= @libdir@
includedir	= @includedir@
datadir		= @datadir@

RANLIB		= @RANLIB@
SHELL		= @SHELL@
PERL		= @PERL@
CC              = @CC@
CFLAGS          = @CFLAGS@ ${XCFLAGS}
CPP             = @CPP@
CPPFLAGS        = @CPP@ ${XCPPFLAGS}
DEFS            = @DEFS@ ${XDEFS}
INCLUDES        = @INCLUDES@ ${XINCLUDES}
LIBS            = @LIBS@ ${XLIBS}
SOCKLIBS        = @SOCKLIBS@

INSTALL		= @INSTALL@
INSTALL_DATA	= @INSTALL_DATA@
INSTALL_PROG	= @INSTALL_PROG@
UNINSTALL	= @UNINSTALL@

AR              = @AR@

ATERM		= @ATERM@
ATERMBIN	= @ATERMBIN@
ATERMLIB	= @ATERMLIB@
ATERMINC	= @ATERMINC@
ASFIX           = @ASFIX@
ASFIXBIN        = @ASFIXBIN@
ASFIXLIB        = @ASFIXLIB@
ASFIXINC        = @ASFIXINC@
TOOLBUS		= @TOOLBUS@
TOOLBUSBIN	= @TOOLBUSBIN@
TOOLBUSLIB	= @TOOLBUSLIB@
TOOLBUSINC	= @TOOLBUSINC@

# Implicit rules
include ${top_srcdir}/implicit-rules

# The eXtra parts of some variables
XCFLAGS         =
XCPPFLAGS       =
XINCLUDES       = -I$(ASFIXINC) -I$(ATERMINC) -I.
XLIBS           = -L$(ASFIXLIB) -L$(ATERMLIB) -lATerm -lAsFix

# Other variables
# CSRC/CHDR are used to calculate dependencies.
CSRC            = meta-paths.c meta-utils.c imports.c module-utils.c
CHDR            = meta-utils.h module-utils.h libutil.h
#All files in BINFILES are installed in $(bindir)
# Ordering is important here: the toolbus dir. should come first
BINFILES	= genmakefile.sh \
		  parse-file parse-sdf2 ps-dot \
                  meta-paths normalize-sdf imports \
                  insert-license insert-header
LIBFILES	= 
DATAFILES	= genmakefile.proto lang.types
INCLUDEFILES	=

OBJ_CC          = $(patsubst %.c,%-cc.o,$(CSRC))
OBJ_GCC         = $(patsubst %.c,%-gcc.o,$(CSRC))
OBJ_DBG         = $(patsubst %.c,%-dbg.o,$(CSRC))
OBJ_PROF        = $(patsubst %.c,%-prof.o,$(CSRC))

# CLEANFILES are removed by 'make clean'
CLEANFILES      = libutils.a insert-license insert-header

# DISTCLEANFILES are removed by 'make distclean'
DISTCLEANFILES  =

all:	${BINFILES} ${LIBFILES} ${DATAFILES}

# Unit test target
test:	all
	@for f in $(BINFILES); do \
		./test-help ./$$f; \
		./test-version ./$$f; \
	done

%: %.sh.src Makefile
	sed 's#__BINDIR__#$(bindir)#g' < $< >$@ && \
	chmod +x $@

%: %.pl.src Makefile
	sed 's#__PERL__#$(PERL)#g' < $< >$@ && \
	chmod +x $@

%-cc.o: %.c
	cc -O $(INCLUDES) -c -o $@ $<

%-gcc.o: %.c
	gcc -Wall -O4 $(INCLUDES) -c -o $@ $<

%-dbg.o: %.c
	gcc -Wall -g $(INCLUDES) -c -o $@ $<

%-prof.o: %.c
	gcc -Wall -pg $(INCLUDES) -c -o $@ $<

libutils.a: meta-utils.o module-utils.o
	$(AR) cr $@ meta-utils.o module-utils.o
	$(RANLIB) $@

meta-paths: meta-paths.o libutils.a
	${CC} -o $@ meta-paths.o libutils.a

imports: imports.o libutils.a
	${CC} -o $@ imports.o libutils.a $(LIBS)


uninstall:
	@$(UNINSTALL) $(bindir) $(BINFILES)
	@$(UNINSTALL) $(libdir) $(LIBFILES)
	@$(UNINSTALL) $(includedir) $(INCLUDEFILES)
	@$(UNINSTALL) $(datadir) $(DATAFILES)

install:	all
	mkdir -p $(bindir) $(libdir) $(includedir) $(datadir)
	@$(INSTALL_PROG) $(INSTALL) $(bindir) $(BINFILES)
	@$(INSTALL_DATA) $(INSTALL) $(includedir) $(INCLUDEFILES)
	@$(INSTALL_DATA) $(INSTALL) $(datadir) $(DATAFILES)

# clean target (remove all easily build components and temporary files)
clean:
	rm -f *.o *~ $(CLEANFILES)
doc:

distclean:

depend:

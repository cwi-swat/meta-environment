#! /bin/sh
# $Id$
Revision='$Revision$'

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
libdir=@libdir@

PATH="$PATH:$bindir"

RM=rm
PARSER="${bindir}/parse-sdf2 -1"
GENERATOR="${bindir}/gen-table"

verbose=0;
error=0;

###
#  Handle the command line, &c.
###

myname=`basename $0`
myversion=`echo $Revision| cut -d' ' -f2`

# The argument vector: list of option letters, colons denote option
# arguments.  See Usage function, immediately below, for option
# explanation.
myarguments="fhsvV"

if [ $myarguments ] ; then
    myargsexplained=$myarguments
    # Add ' -' before, and add ' ' after, all options that have an argument
    myargsexplained="`echo $myargsexplained|sed -e \"s/\(.:\)/ -\1 /g\"`"
    # Add '-' where necessary
    myargsexplained="`echo $myargsexplained|sed -e \"s/ \([^-:]\)/ -\1/g\"`"
    # Replace argument position indicator ':' by ' arg'
    myargsexplained="`echo $myargsexplained|sed -e \"s/:/ arg/g\"`"

    myargsexplained=" -$myargsexplained"
fi

# Usage: displays helpful usage information
Usage() {
cat << E_O_USAGE >&2
Usage: $myname$myargsexplained . . .
Options:
    -f              use handcrafted normalizer (\`fast')
    -h              display help information (usage)
    -s              use compiled specification (\`slow')
    -v              verbose mode
    -V              reveal program version (i.e. $myversion)
E_O_USAGE
}

Version() {
    echo "$myname v$myversion" >&2
}

# getopt handles command line...
args=`getopt $myarguments $* 2> /dev/null`
if test $? != 0
then
        Usage
        exit 2
fi
set -- $args

# Argument interpretation...
while [ $#  -gt 0 ]
do
    case "$1"
    in
        -f)
            PGOPTS="$PGOPTS $1" ;;
        -h)
            Usage ;;
        -s)
            PGOPTS="$PGOPTS $1" ;;
        -v)
            verbose=1 ;;
        -V)
            Version ;;
        --)
            shift; break;;
    # Add additional command line options here...
    *)
            Usage ;;
    esac
    shift
done


###
#  Get to the real work now...
###


Warn () {
	echo $*                                   	>&2
}

Error () {
	Warn $*
	error=1
}

Abort () {
	Error $*
	exit 2
}

Notify () {
	if [ $verbose -gt 0 ] ; then
		Warn $*
	fi
}


#
## Main bit...
#

if [ $verbose -gt 0 ] ; then
	VERBOSE="-v"
else
	VERBOSE=""
fi


for f in $@
do
	base=`dirname $f`/`basename $f .sdf2`
	af1name=$base.asfix1
	tblname=$base.tbl
	Notify "Parsing $f..."
	if $PARSER $VERBOSE $f -o $af1name
	then
	        Notify "Generating parse table ..."
	        if $GENERATOR $VERBOSE $PGOPTS $af1name
		then
			${RM} -f $af1name
		else
			Warn "Error rewriting $f"
			error=1
		fi
	else
		Warn "Error parsing $f"
		error=1
	fi
done

exit $error;

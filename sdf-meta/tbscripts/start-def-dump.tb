#define TODO(m) printf("%s:%d - TODO: %s\n", __FILE__, __LINE__, m)

/* meta-kernel */
#include <module-utils.tb>
#include <error-utils.tb>
#include <error-output.tb>

/* sdf-meta */
#include <sdf-initialize.tb>
#include <sdf-module-actions.tb>
#include <sdf-listeners.tb>
#include <sdf-utils.tb>
#include <sdf2-language.tb>
#include <term-parsetable.tb>

process StartDefinitionDumper is
let
  MenuEventList: list,
  ModuleId: term,
  Event: attribute-changed-event,
  Value: term
in
  OpenModule(MODULENAME, ModuleId?)
  . MM-Subscribe-Attribute-Changed(ModuleId,SDF_NAMESPACE,"status",<term>,complete)
  . MM-Subscribe-Attribute-Changed(<term>,SDF_NAMESPACE,"status",<term>,error)
  . MM-Subscribe-Attribute-Changed(<term>,SDF_NAMESPACE,"status",<term>,unavailable)
  . rec-note(mm-attribute-changed(Event?))
  . ACE-GetNewValue(Event, Value?)
  . 
  if or(equal(Value, error), equal(Value, unavailable)) then
    printf("Error occurred loading %t\n", MODULENAME)
  else
    DumpSdfDefinition(ModuleId, OUTPUTFILE)
  fi
  . shutdown("")
endlet

toolbus(StartDefinitionDumper)

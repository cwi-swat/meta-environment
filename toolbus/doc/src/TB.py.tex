
\section{\label{TB.py}Python $\leftrightarrow$ Python adapter
interface}

The Python $\leftrightarrow$ Python adapter interface is a Python
module which can be used to send (error) messages and events to the
\TB\ and to convert Python strings to \TB\ strings and back. Note that
the path to this module is automatically added to the library load-path
by the Python adapter and that user scripts need to import this
module when they use these functions (following Python conventions).
\nwfilename{TB.py.nw}\nwbegincode{1}\sublabel{NWTB.8-TB.5-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWTB.8-TB.5-1}}}\moddef{TB.py~{\nwtagstyle{}\subpageref{NWTB.8-TB.5-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwprevnextdefs{\relax}{NWTB.8-TB.5-2}\nwenddeflinemarkup
# -----------------------------------------------------------------------
# TB.py -- fixed interface code for Python <-> Python adapter communication
#
# Author:       Leon Moonen,
# Time-stamp:   <95/08/28 21:55:35 leon>
#
# -----------------------------------------------------------------------
# Predefined function that can be used freely in each Python script:
#
# TBstring:    convert a Python string to ToolBus format
# PYstring:    convert a ToolBus message to a Python string
# send:        send a message to the ToolBus
# event:       wrap a message as an event and send to the ToolBus
# error:       wrap a message as an error message and send to TB
# require:     check if given function exists in given module
#------------------------------------------------------------------------

import sys
import regsub
import regex
import __main__
\nwalsodefined{\\{NWTB.8-TB.5-2}\\{NWTB.8-TB.5-3}\\{NWTB.8-TB.5-4}\\{NWTB.8-TB.5-5}\\{NWTB.8-TB.5-6}\\{NWTB.8-TB.5-7}\\{NWTB.8-TB.5-8}}\nwnotused{TB.py}\nwendcode{}\nwbegindocs{2}\nwdocspar
The function \txttt{TBstring} converts a Python string to a \TB\
string i.e. all double quotes are escaped and the string is surrounded
with double quotes.
\nwenddocs{}\nwbegincode{3}\sublabel{NWTB.8-TB.5-2}\nwmargintag{{\nwtagstyle{}\subpageref{NWTB.8-TB.5-2}}}\moddef{TB.py~{\nwtagstyle{}\subpageref{NWTB.8-TB.5-1}}}\plusendmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwprevnextdefs{NWTB.8-TB.5-1}{NWTB.8-TB.5-3}\nwenddeflinemarkup
def TBstring(str):
        newstr = regsub.gsub('\\"','\\\\\\"',str)
        return('\\"%s\\"' % newstr) 
\nwendcode{}\nwbegindocs{4}\nwdocspar
The function \txttt{PYstring} converts a \TB\ message to a Python
string i.e. strip the string length information and remove surrounding 
double quotes.
\nwenddocs{}\nwbegincode{5}\sublabel{NWTB.8-TB.5-3}\nwmargintag{{\nwtagstyle{}\subpageref{NWTB.8-TB.5-3}}}\moddef{TB.py~{\nwtagstyle{}\subpageref{NWTB.8-TB.5-1}}}\plusendmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwprevnextdefs{NWTB.8-TB.5-2}{NWTB.8-TB.5-4}\nwenddeflinemarkup
def PYstring(str):
        comp = regex.compile('\\"[0-9]+:\\(.*\\)\\"')
        if (comp.match(str) != -1):
                return(comp.group(1))
        else:
                comp = regex.compile('\\"\\(.*\\)\\"')
                if (comp.match(str) != -1):
                        return(comp.group(1))
                else:
                        return(str)
\nwendcode{}\nwbegindocs{6}\nwdocspar
The function \txttt{send} converts a Python message to a \TB\ message
(i.e. add length information) and sends it to the \TB.
\nwenddocs{}\nwbegincode{7}\sublabel{NWTB.8-TB.5-4}\nwmargintag{{\nwtagstyle{}\subpageref{NWTB.8-TB.5-4}}}\moddef{TB.py~{\nwtagstyle{}\subpageref{NWTB.8-TB.5-1}}}\plusendmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwprevnextdefs{NWTB.8-TB.5-3}{NWTB.8-TB.5-5}\nwenddeflinemarkup
# The following function depends on
# LENSPEC = 8 and MIN_MSG_SIZE = 128 (see utils.[ch])
# THIS SHOULD BE PARAMETERIZED !!!

def send(msg):
        length = len(msg) + 8
        msg = '%.7d:' % length + msg
        sys.stdout.write('%-128s' % msg)
        sys.stdout.flush()
\nwendcode{}\nwbegindocs{8}\nwdocspar
The function \txttt{msg} prints a message to the stderr object.
\nwenddocs{}\nwbegincode{9}\sublabel{NWTB.8-TB.5-5}\nwmargintag{{\nwtagstyle{}\subpageref{NWTB.8-TB.5-5}}}\moddef{TB.py~{\nwtagstyle{}\subpageref{NWTB.8-TB.5-1}}}\plusendmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwprevnextdefs{NWTB.8-TB.5-4}{NWTB.8-TB.5-6}\nwenddeflinemarkup
# <PO>: TB.msg is sometimes handy.
def msg(message):
        sys.stderr.write('%s - %s' % (sys.argv[0], message))
        sys.stderr.flush()
\nwendcode{}\nwbegindocs{10}\nwdocspar
The function \txttt{error} converts a Python error message to a \TB\
error message by converting it to a \TB\ string which is wrapped in a
\txttt{python-adapter-error()} term and sent to the \TB\ (shorthand for
  \txttt{TB.send('python-adapter-error(\%s)' \% msg)}).
\nwenddocs{}\nwbegincode{11}\sublabel{NWTB.8-TB.5-6}\nwmargintag{{\nwtagstyle{}\subpageref{NWTB.8-TB.5-6}}}\moddef{TB.py~{\nwtagstyle{}\subpageref{NWTB.8-TB.5-1}}}\plusendmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwprevnextdefs{NWTB.8-TB.5-5}{NWTB.8-TB.5-7}\nwenddeflinemarkup
def error(msg):
        send('python-adapter-error(%s)' % TBstring(msg))
\nwendcode{}\nwbegindocs{12}\nwdocspar
The function \txttt{event} converts a Python message to a \TB\
event message by converting it to a \TB\ string which is wrapped in a
\txttt{snd-event()} term and sent to the \TB\ (shorthand for
  \txttt{TB.send('snd-event(\%s)' \% msg)}).
\nwenddocs{}\nwbegincode{13}\sublabel{NWTB.8-TB.5-7}\nwmargintag{{\nwtagstyle{}\subpageref{NWTB.8-TB.5-7}}}\moddef{TB.py~{\nwtagstyle{}\subpageref{NWTB.8-TB.5-1}}}\plusendmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwprevnextdefs{NWTB.8-TB.5-6}{NWTB.8-TB.5-8}\nwenddeflinemarkup
def event(msg):
        send('snd-event(%s)' % msg)
\nwendcode{}\nwbegindocs{14}\nwdocspar
The function \txttt{require} checks if the given function is defined
in the given module otherwise an error message is send to the
\TB. {\bf Note:} for the moment, it is impossible in Python to check
the number or the type of the arguments of a function. The \emph{args}
parameter is there for future enhancements in Python which may allow
these checks. 
\nwenddocs{}\nwbegincode{15}\sublabel{NWTB.8-TB.5-8}\nwmargintag{{\nwtagstyle{}\subpageref{NWTB.8-TB.5-8}}}\moddef{TB.py~{\nwtagstyle{}\subpageref{NWTB.8-TB.5-1}}}\plusendmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwprevnextdefs{NWTB.8-TB.5-7}{\relax}\nwenddeflinemarkup
def require(mod, fun, args):
        if not(hasattr(mod, fun) and callable(getattr(mod, fun))):
                error("%s: missing function '%s'" % (mod,fun))
\nwendcode{}

\nwixlogsorted{c}{{TB.py}{NWTB.8-TB.5-1}{\nwixd{NWTB.8-TB.5-1}\nwixd{NWTB.8-TB.5-2}\nwixd{NWTB.8-TB.5-3}\nwixd{NWTB.8-TB.5-4}\nwixd{NWTB.8-TB.5-5}\nwixd{NWTB.8-TB.5-6}\nwixd{NWTB.8-TB.5-7}\nwixd{NWTB.8-TB.5-8}}}%
\nwbegindocs{16}\nwdocspar

\nwenddocs{}


\section{\label{ToolsInTcl}Writing tools in Tcl/Tk}

Writing \TB\ tools in Tcl is greatly simplified by the {\tt wish-adapter}
to be explained in Section~\ref{wish-adapter}.
Next, a small set of predefined Tcl functions is described that are
always loaded by the {\tt wish-adapter} and can be used in any Tcl script
(Section~\ref{Tcl-functions}).
Finally, we present in Section~\ref{Ex-hello.tcl} the Tcl version
of the {\tt hello} tool.

\subsection{\label{wish-adapter}{\tt wish-adapter}}

\paragraph{Synopsis.} Execute Tcl/Tk's windowing shell {\tt wish} as a tool.

\paragraph{Example.} {\tt wish-adapter -script calculator.tcl}

\paragraph{Specific arguments.}
\begin{itemize}
\item {\tt -wish $Name$}: Use $Name$ rather than {\tt wish} as Tcl/Tk's windowing shell.
\item {\tt -lazy-exec}: Postpone execution of {\tt wish} until needed.
\item {\tt -script}: The Tcl script to be executed.
\item {\tt -script-args}: The arguments for the Tcl script to be executed.
      These arguments are available to the Tcl script throught the variables
      {\tt argc} and {\tt argv}.
\end{itemize}

\paragraph{Communication.} \hspace{-0.3cm}\footnote{Communication is described
from the point of view of the \TB, i.e., {\tt snd-} and {\tt rec-}
mean, respectively, send by \TB\ and receive by \TB.}

\begin{itemize}
\item {\tt snd-do($Tid$, $Fun$($A_1$, ..., $A_n$))}: perform the Tcl function
call
{\tt $Fun$ $A_1$  ... $A_n$}. Here $Tid$ is a tool identifier
(as produced by {\tt execute} or {\tt rec-connect}) for an instance of the {\tt
wish-adapter}.
\item {\tt snd-eval($Tid$, $Fun$($A_1$, ..., $A_n$))}: perform the Tcl function call
{\tt $Fun$ $A_1$  ... $A_n$}. Here $Tid$ is a tool identifier 
(as produced by {\tt execute} or {\tt rec-connect}) for an instance of the {\tt wish-adapter}.
Note that the function {\tt $Fun$} must send an anser back to the
ToolBus (using {\tt TBsend "snd-eval(...)"}).
\item {\tt rec-value($Tid$,$Res$)}: the return value for a previous evaluation request.
\item {\tt rec-event($Tid$, $A_1$, ..., $A_n$)}: event generated by wish.
\item {\tt snd-ack-event($Tid$, $A_1$)}: acknowledgement of
a previously generated event.
\item {\tt snd-terminate($Tid$, $A_1$)}: terminate execution of wish-adapter.
\item \texttt{snd-monitor(\emph{Trm})}: in this case the Tcl
  function \texttt{monitor\_atom \{\emph{ProcId} \emph{AtFun},
    \emph{Src} \emph{Blino} \emph{Bpos} \emph{Elino} \emph{Epos}\}}
  is called where \emph{ProcId} is the process-id of the process to
  which this atom belongs, \emph{AtFun} is the action function name of
  the atom (printf, tau, snd-do, snd-eval, rec-msg etc.), \emph{Src} the
  source file where the atom is defined, \emph{Blino} the number of
  the line where the atom starts, \emph{Bpos} the column of the
  line where the atom starts, \emph{Elino} the number of the line
  where the atom ends and \emph{Epos} is the column of the line where
  the atom ends (this information can be used for example for
  highlightning a piece of source code). 
  After calling this function the term is further analyzed,
  possibly resulting in (several) other Tcl function
  calls. The following situations are considered:
  \begin{itemize}
  \item \emph{process creation}:
    \texttt{create\_proc \{\emph{ProcId} \emph{ProcName}\}} is
    called.
  \item \emph{tool creation}: \texttt{create\_tool \{\emph{ToolId}
      \emph{ToolName}\}} is called.
  \item \emph{process to tool communication}:
    \texttt{proc\_tool\_comm \{\emph{ToolId} \emph{ProcId}\}} is
    called.
  \item \emph{tool to process communication}:
    \texttt{tool\_proc\_comm \{\emph{ProcId} \emph{ToolId}\}} is
    called.
  \item \emph{process to process communication}:
    \texttt{proc\_proc\_comm \{\emph{ProcId1} \emph{ProcId2}\}} is
    called.
  \item \emph{update the value of a variable in a process}:
    \texttt{update\_var \{\emph{ProcId} \emph{VarName}
      \emph{NewValue}\}} is called.
  \item \emph{update the list of subscribtions of a process}:
    \texttt{update\_subs \{\emph{ProcId} \emph{Subs}\}} is called.
  \item \emph{update the list of notes of a process}:
    \texttt{update\_notes \{\emph{ProcId} \emph{Notes}\}} is called.
  \end{itemize}
\end{itemize}

\noindent The command {\tt wish} is executed once, an initial Tcl script
is read, and all further requests are directed to this incarnation
of {\tt wish}. A small set of Tcl procedures is available for
unpacking and packing \TB\ terms (see below).

\subsection{\label{Tcl-functions}Predefined Tcl functions}
The following Tcl functions are predefined and can be used freely in Tcl
script executed via the wish-adapter:
\begin{itemize}
\item {\tt TBstring $Str$\/}: converts a Tcl string to a \TB\ string by
surrounding it with double quotes and escaping double quotes occurring
inside $Str$.

\item {\tt TCLstring $Str$\/}: converts a \TB\ string into  a Tcl string
by removing surrounding double quotes.

\item {\tt TBlist $List$\/}: converts a Tcl list to a \TB\ list by
separating the elements with commas and surrounding the list by
curly braces.

\item {\tt TBerror $Msg$\/}: constructs an error message that can be sent
to the \TB.

\item {\tt TBsend $Trm$\/}: send $Trm$ back to the \TB.

\item {\tt TBevent $Event$\/}: send event $Event$ to the \TB.

\item {\tt TBrequire $ToolName$ $ProcName$ $Nargs$} check
that the Tcl code for $ToolName$ contains a procedure declaration
for $ProcName$ with $Nargs$ formal parameters.
This function is mainly used by the {\tt wish-adapter} to check
compatibility of the Tcl code with the expected input
signature of the tool.
\end{itemize}

\paragraph{Note.} All communication between wish-adapter and a
 tool written in Tcl is done via standard input/output. {\bf Only use
the standard error stream for print statements in the Tcl script,
since using standard output will disrupt the communication with the
\TB}.

\subsection{\label{Ex-hello.tcl}The hello example in tcl: {\tt hello.tcl}}

Writing the hello tool in Tcl requires two steps:
\begin{itemize}
\item Write the required Tcl code {\tt hello.tcl}. The result is shown in Figure~\ref{fig:hello.tcl}.
\item Replace {\tt hello}'s tool definition in {\tt hello2.tb} by:
\begin{verbatim}
      tool hello is {command = "wish-adapter -script hello.tcl"}
\end{verbatim}
\end{itemize}


\begin{figure}
\rule{\textwidth}{0.5mm}
\input{../demos/hello/hello.tcl.tex}
  \caption{{\tt hello.tcl}: the hello tool in Tcl}
  \label{fig:hello.tcl}
\rule{\textwidth}{0.5mm}
\end{figure}

# @configure_input@
# directory: src

PRODUCT 	= @PRODUCT@
VERSION 	= @VERSION@

SHELL		= /bin/sh
srcdir		= @srcdir@
VPATH		= @srcdir@
top_srcdir	= @top_srcdir@

CC		= @CC@
CFLAGS		= @CFLAGS@
CPP		= @CPP@
CPPFLAGS 	= @CPPFLAGS@
DEFS 		= @DEFS@ -DVERSION="\"$(VERSION)\""
LIBS		= @LIBS@
SHARED_TB_LIB	= @SHARED_TB_LIB@
MODULES		= @MODULES@

AR		= @AR@
RANLIB		= @RANLIB@
INSTALL		= @INSTALL@
INSTALL_PROGRAM	= @INSTALL_PROGRAM@
LEX		= @LEX@
LEXLIB		= @LEXLIB@
YACC		= @YACC@
YACCLIB		= @YACCLIB@
CLEAN		= @CLEAN@
NOWEB		= @NOWEB@
@SET_MAKE@

prefix 		= @prefix@
exec_prefix 	= @exec_prefix@
bindir 		= $(exec_prefix)/bin
libdir		= $(exec_prefix)/lib
includedir	= $(prefix)/include

COMPILE = $(CC) -c $(DEFS) $(INCLUDES) $(CPPFLAGS) $(CFLAGS)
LINK = $(CC) $(LDFLAGS) -o $@

.SUFFIXES:
.SUFFIXES: .c .o .y .l
.c.o:
	$(COMPILE) $<

.l.c:
	$(LEX) $<
.y.c:
	$(YACC) $<

INCLUDES 	= -I$(srcdir)

HEADERS		= env.h interpreter.h match.h procs.h terms.h tools.h tool2.h\
		  toolbus.h sockets.h tool.h monitor.h typecheck.h utils.h\
		  TB.h symbol.h evq.h

SOURCES_C	= client.c \
		  env.c  interpreter.c  match.c procs.c terms.c tools.c\
		  server.c sockets.c tool.c tool2.c monitor.c typecheck.c\
		  utils.c txt_dbg.c main.c ctif.c script2latex.c verbatim.c\
		  symbol.c calls.c evq.c

OBJECTS		= y.tab.o  client.o \
		  env.o interpreter.o match.o  procs.o terms.o tools.o  \
		  server.o sockets.o tool.o tool2.o monitor.o  typecheck.o\
		  utils.o main.o symbol.o calls.o evq.o $(MODULES)

SOURCES_Y	= script.l script.y

LIB_OBJECTS	= client.o sockets.o terms.o tool.o tool2.o utils.o symbol.o \
		evq.o

DISTFILES	= Makefile.in $(HEADERS) $(SOURCES_C) $(SOURCES_Y) logger.tcl \
		viewer.tcl evq.c.nw

BUILD_TARGETS	= libtb.a toolbus ctif script2latex verbatim ${SHARED_TB_LIB}
TARGETS		= ${BUILD_TARGETS} logger.tcl viewer.tcl

# INIT_MODULES	= $(MODULES:.o=_init_module();)
INIT_MODULES	=

all:	${BUILD_TARGETS}

toolbus: ${OBJECTS} 
	${CC} ${CFLAGS} ${OBJECTS} -o toolbus ${LEXLIB} ${YACCLIB} ${LIBS}

libtb.a: ${LIB_OBJECTS}
	${AR} cr libtb.a ${LIB_OBJECTS}
	${RANLIB} libtb.a

libtb.so: ${LIB_OBJECTS}
	${CC} -G -olibtb.so ${LIB_OBJECTS}

txt_dbg: txt_dbg.o
	${CC} ${CFLAGS} txt_dbg.o -o txt_dbg libtb.a ${LIBS}
ctif: TB.h ctif.c
	${CC} ${CFLAGS} ctif.c -o ctif libtb.a ${LIBS}
script2latex: script2latex.c
	${CC} ${CFLAGS} script2latex.c -o script2latex	
verbatim: verbatim.c
	${CC} ${CFLAGS} verbatim.c -o verbatim		

txt_dbg.o: 	TB.h txt_dbg.c

terms.o: 	toolbus.h terms.h symbol.h terms.c tools.h procs.h
symbol.o:	toolbus.h terms.h symbol.h procs.h tools.h utils.h symbol.c
env.o:		toolbus.h terms.h env.h env.c
match.o:  	toolbus.h terms.h env.h procs.h match.h utils.h match.c
procs.o: 	toolbus.h terms.h env.h match.h procs.h tools.h procs.c
calls.o:	toolbus.h terms.h env.h procs.h interpreter.h calls.c
interpreter.o: 	toolbus.h terms.h env.h procs.h match.h utils.h interpreter.h interpreter.c
sockets.o:	toolbus.h terms.h utils.h sockets.h sockets.c
server.o: 	toolbus.h terms.h utils.h server.c
monitor.o: toolbus.h terms.h env.h procs.h tools.h match.h utils.h interpreter.h monitor.h monitor.c
	${COMPILE} -DVIEWER_TCL=\"$(libdir)/viewer.tcl\" \
		-DLOGGER_TCL=\"$(libdir)/logger.tcl\" monitor.c
client.o: 	toolbus.h terms.h utils.h client.c
utils.o: 	toolbus.h terms.h utils.h utils.c
tools.o: 	toolbus.h terms.h env.h procs.h utils.h interpreter.h tools.h tools.c
main.o: 	toolbus.h terms.h env.h procs.h utils.h interpreter.h tools.h main.c
	${COMPILE} -DINIT_MODULES="$(INIT_MODULES)" main.c

typecheck.o: 	toolbus.h terms.h env.h procs.h utils.h interpreter.h typecheck.h typecheck.c
tool.o:		toolbus.h terms.h utils.h tool.h tool.c
tool2.o:	toolbus.h terms.h utils.h tool2.h tool2.c
modtest.o:	modtest.c
evq.o:		evq.c

evq.c evq.h: evq.c.nw
	$(NOWEB) evq.c.nw
	touch evq.c evq.h

y.tab.o: y.tab.c
	${COMPILE} -DCPP='"$(CPP)"' y.tab.c

lex.yy.c: script.l
	${LEX} $(srcdir)/script.l

y.tab.c: script.l lex.yy.c script.y toolbus.h terms.h env.h procs.h match.h utils.h interpreter.h
	${YACC} $(srcdir)/script.y

print: ${HEADERS} ${SOURCES_C} ${SOURCES_Y}
	enscript -fCourier8 -p tmpxx ${HEADERS} ${SOURCES_C} ${SOURCES_Y}; lp tmpxx; rm tmpxx

clean:
	${CLEAN}
	rm -f ${BUILD_TARGETS} toolbus.Counts toolbus.Addrs toolbus.pixie mon.out

distclean: clean
	rm -f Makefile

dist: $(DISTFILES)
	@for file in $(DISTFILES); do \
	  ln $(srcdir)/$$file ../../$(PRODUCT)-$(VERSION)/src 2> /dev/null \
	  || cp $(srcdir)/$$file ../../$(PRODUCT)-$(VERSION)/src; \
	done

install: ${TARGETS}
	$(INSTALL) toolbus $(bindir)
#	$(INSTALL) txt_dbg $(bindir)
	$(INSTALL) ctif $(bindir)
	$(INSTALL) script2latex $(bindir)
	$(INSTALL) verbatim $(bindir)
	$(INSTALL) -m 644 logger.tcl $(libdir)
	$(INSTALL) -m 644 viewer.tcl $(libdir)
	for file in libtb.a $(SHARED_TB_LIB); do \
	  $(INSTALL) $$file $(libdir); \
	done
	for file in $(HEADERS); do \
	   $(INSTALL) -m 644 $$file $(includedir); \
	done

uninstall:
	rm -f $(bindir)/toolbus
	rm -f $(bindir)/ctif
	rm -f $(bindir)/script2latex
	rm -f $(bindir)/verbatim
	rm -f $(libdir)/logger.tcl
	rm -f $(libdir)/viewer.tcl
	rm -f $(libdir)/libtb.a
	rm -f $(includedir)/TB.h

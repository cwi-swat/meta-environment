
%{{{ tcltk-adapter.c

The file tcltk-adapter.c implements the Tcl/Tk adapter, and consists
of the following sections:
\nwfilename{tcltk-adapter.c.nw}\nwbegincode{1}\sublabel{NWtclI-tclG-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-tclG-1}}}\moddef{tcltk-adapter.c*~{\nwtagstyle{}\subpageref{NWtclI-tclG-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwenddeflinemarkup
\LA{}includes~{\nwtagstyle{}\subpageref{NWtclI-inc8-1}}\RA{}
\LA{}variables~{\nwtagstyle{}\subpageref{NWtclI-var9-1}}\RA{}
\LA{}functions~{\nwtagstyle{}\subpageref{NWtclI-fun9-1}}\RA{}
\LA{}reset_buffer~{\nwtagstyle{}\subpageref{NWtclI-resC-1}}\RA{}
\LA{}printb_str~{\nwtagstyle{}\subpageref{NWtclI-priA-1}}\RA{}
\LA{}printb_char~{\nwtagstyle{}\subpageref{NWtclI-priB-1}}\RA{}
\LA{}wish_type_string~{\nwtagstyle{}\subpageref{NWtclI-wisG-1}}\RA{}
\LA{}print_escaped_char~{\nwtagstyle{}\subpageref{NWtclI-priI-1}}\RA{}
\LA{}printn_wish~{\nwtagstyle{}\subpageref{NWtclI-priB.2-1}}\RA{}
\LA{}pr_term_wish~{\nwtagstyle{}\subpageref{NWtclI-pr*C-1}}\RA{}
\LA{}pr_string_wish~{\nwtagstyle{}\subpageref{NWtclI-pr*E-1}}\RA{}
\LA{}pr_type_wish~{\nwtagstyle{}\subpageref{NWtclI-pr*C.2-1}}\RA{}
\LA{}pr_term_list_wish~{\nwtagstyle{}\subpageref{NWtclI-pr*H-1}}\RA{}
\LA{}pr_env_wish~{\nwtagstyle{}\subpageref{NWtclI-pr*B-1}}\RA{}
\LA{}TclString2Term~{\nwtagstyle{}\subpageref{NWtclI-TclE-1}}\RA{}
\LA{}toolbus_input~{\nwtagstyle{}\subpageref{NWtclI-tooD-1}}\RA{}
\LA{}from_toolbus~{\nwtagstyle{}\subpageref{NWtclI-froC-1}}\RA{}
\LA{}Tcl_TBsend~{\nwtagstyle{}\subpageref{NWtclI-TclA-1}}\RA{}
\LA{}Tcl_TBstring~{\nwtagstyle{}\subpageref{NWtclI-TclC-1}}\RA{}
\LA{}Tcl_AppInit~{\nwtagstyle{}\subpageref{NWtclI-TclB-1}}\RA{}
\LA{}handle_args~{\nwtagstyle{}\subpageref{NWtclI-hanB-1}}\RA{}
\LA{}main~{\nwtagstyle{}\subpageref{NWtclI-mai4-1}}\RA{}
\nwnotused{tcltk-adapter.c*}\nwendcode{}\nwbegindocs{2}\nwdocspar

%}}}

%{{{ includes

We need to know some things about the ToolBus and about Tcl/Tk.

\nwenddocs{}\nwbegincode{3}\sublabel{NWtclI-inc8-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-inc8-1}}}\moddef{includes~{\nwtagstyle{}\subpageref{NWtclI-inc8-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
#include <TB.h>
#include <tcl.h>
#include <tk.h>
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{4}\nwdocspar

%}}}
%{{{ variables

The global variable section.

\nwenddocs{}\nwbegincode{5}\sublabel{NWtclI-var9-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-var9-1}}}\moddef{variables~{\nwtagstyle{}\subpageref{NWtclI-var9-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
/* 20 Kb should suffice for most applications. */
#define DEFAULT_BUF_SIZE        20480

char *script;
char *name;

Tcl_Interp *interp;

int bufsize = DEFAULT_BUF_SIZE;
char *BUF;
int offset;
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{6}\nwdocspar

%}}}
%{{{ functions

Some handy function declarations.

\nwenddocs{}\nwbegincode{7}\sublabel{NWtclI-fun9-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-fun9-1}}}\moddef{functions~{\nwtagstyle{}\subpageref{NWtclI-fun9-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
void pr_type_wish(type *tp);
void pr_term_list_wish(const term_list *tl, char sep);
void pr_env_wish(const env *e);
void pr_string_wish(char *s, int len);
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{8}\nwdocspar

%}}}

%{{{ void reset_buffer()

\nwenddocs{}\nwbegincode{9}\sublabel{NWtclI-resC-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-resC-1}}}\moddef{reset_buffer~{\nwtagstyle{}\subpageref{NWtclI-resC-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
void reset_buffer()
\{
  offset = 0;
  BUF[0] = '\\0';
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{10}\nwdocspar
%}}}

%{{{ void printb_str(char *str)

Print a string in the internal buffer.

\nwenddocs{}\nwbegincode{11}\sublabel{NWtclI-priA-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-priA-1}}}\moddef{printb_str~{\nwtagstyle{}\subpageref{NWtclI-priA-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
void printb_str(char *str)
\{
  int len = strlen(str);

  if(offset + len > bufsize)
    TBprintf(stderr, "Buffer overflow, ignoring %s\\n", str);
  else \{
    strcpy(&BUF[offset], str);
    offset += len;
    BUF[offset] = '\\0';
  \}
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{12}\nwdocspar
%}}}
%{{{ void printb_char(char c)

Print a char in the internal buffer.

\nwenddocs{}\nwbegincode{13}\sublabel{NWtclI-priB-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-priB-1}}}\moddef{printb_char~{\nwtagstyle{}\subpageref{NWtclI-priB-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
void printb_char(char c)
\{
  if(offset >= bufsize)
    TBprintf(stderr, "Buffer overflow, ignoring %c\\n", c);
  else \{
    BUF[offset++] = c;
    BUF[offset] = '\\0';
  \}
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{14}\nwdocspar

%}}}

%{{{ char *wish_type_string(tkind kind)

Return a string representing the indicated type.

\nwenddocs{}\nwbegincode{15}\sublabel{NWtclI-wisG-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-wisG-1}}}\moddef{wish_type_string~{\nwtagstyle{}\subpageref{NWtclI-wisG-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
char *wish_type_string(tkind kind)
\{
  static char *types[] =
    \{ "term", "bool", "int", "real", "str", "bstr", "var",
      "placeholder", "appl", "env", "list"
    \};

  if(kind >= t_term && kind <= t_list)
    return types[kind];

  return "unknown";
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{16}\nwdocspar

%}}}
%{{{ void print_escaped_char(char c)

Print an escaped character.

\nwenddocs{}\nwbegincode{17}\sublabel{NWtclI-priI-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-priI-1}}}\moddef{print_escaped_char~{\nwtagstyle{}\subpageref{NWtclI-priI-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
void print_escaped_char(char c)
\{
  /* In a string, we just escape the character. */
  char Buf[6];
  int i;
  
  sprintf(Buf, "\\\\%o", ((unsigned int)c) & 0xFF);
  printb_str(Buf);
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{18}\nwdocspar

%}}}
%{{{ void printn_wish(const char *s, int n)

Print a wish string to the internal buffer.

\nwenddocs{}\nwbegincode{19}\sublabel{NWtclI-priB.2-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-priB.2-1}}}\moddef{printn_wish~{\nwtagstyle{}\subpageref{NWtclI-priB.2-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
void printn_wish(const char *s, int n)
\{
  static TBbool instring = TBfalse;
  static TBbool prev_escaped = TBfalse;

  while(n)\{
    if(*s == '"') \{
      printb_char('\\\\');
      if(instring)
        \{
          instring = TBfalse;
          prev_escaped = TBfalse;
        \}
      else
        instring = TBtrue;
    \}

    if(instring)
      \{
        if(*s == '\\\\' || *s == '[' || *s == ']')
          printb_char('\\\\');
        prev_escaped = TBfalse;
      \}

    if(isprint(*s))
      \{
        /* We don't want an octal digit after an escaped number! */
        if(prev_escaped && *s >= '0' && *s <= '7')
          print_escaped_char(*s++);
        else
          printb_char(*s++);
        prev_escaped = TBfalse;
      \}
    else
      \{
        /* We have a non-printable character */
        print_escaped_char(*s++);
        prev_escaped = TBtrue;
      \}

    n--;
  \}
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{20}\nwdocspar

%}}}
%{{{ void pr_term_wish(term *t)

Print a term in the internal buffer.

\nwenddocs{}\nwbegincode{21}\sublabel{NWtclI-pr*C-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-pr*C-1}}}\moddef{pr_term_wish~{\nwtagstyle{}\subpageref{NWtclI-pr*C-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup

void pr_term_wish(term *t)
\{
  char cbuf[100], *ftxt;

  /* TBprintf(stderr, "Term: %t\\n", t);*/
  if(!t)\{
    printn_wish("\{\}",2);
    return;
  \}
  switch(tkind(t))
    \{
    case t_str:
      pr_string_wish(str_val(t), strlen(str_val(t)));
      break;

    case t_bstr:
      pr_string_wish(bstr_val(t), bstr_len(t));
      break;

    case t_bool:
      if(bool_val(t)) 
        printn_wish("true", 4);
      else
        printn_wish("false", 4);
      break;

    case t_int:
      sprintf(cbuf, "%d", int_val(t));
      printn_wish(cbuf, strlen(cbuf));
      break;

    case t_real:
      sprintf(cbuf, "%f", real_val(t));
      printn_wish(cbuf, strlen(cbuf));
      break;

    case t_var: /* Can't occur ??? */
      ftxt = get_txt(var_sym(t));
      printn_wish(ftxt, strlen(ftxt));
      pr_type_wish(var_type(t));
      if(var_result(t))
        printn_wish("?",1);
      break;

    case t_placeholder:
      printn_wish("<",1);
      pr_term_wish(placeholder_type(t));
      printn_wish(">",1);
      break;

    case t_appl:
      ftxt = get_txt(fun_sym(t));
      printn_wish(ftxt, strlen(ftxt));
      if(fun_args(t) != NULL || isupper(ftxt[0]))\{
        printn_wish("(", 1);
        pr_term_list_wish(fun_args(t), ',');
        printn_wish(")", 1);
      \}
      break;

    case t_list:
      printn_wish("\{", 1); 
      pr_term_list_wish(t, ' ');
      printn_wish("\}", 1);
      break;

    case t_env:
      pr_env(t);
      break;
    \}
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{22}\nwdocspar

%}}}
%{{{ void pr_string_wish(char *s, int len)

Print a string in the internal wish buffer.

\nwenddocs{}\nwbegincode{23}\sublabel{NWtclI-pr*E-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-pr*E-1}}}\moddef{pr_string_wish~{\nwtagstyle{}\subpageref{NWtclI-pr*E-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
void pr_string_wish(char *s, int len)
\{
  printb_char('\\"');
  printn_wish(s, len);
  printb_char('\\"');
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{24}\nwdocspar

%}}}
%{{{ void pr_type_wish(type *tp)

Print a type in the internal buffer.

\nwenddocs{}\nwbegincode{25}\sublabel{NWtclI-pr*C.2-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-pr*C.2-1}}}\moddef{pr_type_wish~{\nwtagstyle{}\subpageref{NWtclI-pr*C.2-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
void pr_type_wish(type *tp)
\{
  printn_wish(":", 1); 
  pr_term_wish(tp);
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{26}\nwdocspar

%}}}
%{{{ void pr_term_list_wish(const term_list *tl, char sep)

Print a list of terms in the internal buffer.

\nwenddocs{}\nwbegincode{27}\sublabel{NWtclI-pr*H-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-pr*H-1}}}\moddef{pr_term_list_wish~{\nwtagstyle{}\subpageref{NWtclI-pr*H-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
void pr_term_list_wish(const term_list *tl, char sep)
\{
  TBbool first = TBtrue;

  for( ; tl; tl = next(tl))\{
    assert(is_list(tl));    
    if(first)
      first = TBfalse;
    else
      printn_wish(&sep, 1);
    pr_term_wish(first(tl));
  \}
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{28}\nwdocspar

%}}}
%{{{ void pr_env_wish(const env *e)

Print an environment in the internal buffer.

\nwenddocs{}\nwbegincode{29}\sublabel{NWtclI-pr*B-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-pr*B-1}}}\moddef{pr_env_wish~{\nwtagstyle{}\subpageref{NWtclI-pr*B-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
void pr_env_wish(const env *e)
\{
  TBbool first = TBtrue;
  char *ftxt;

  printn_wish("\{", 1);
  for( ; e; e = env_next(e))\{
    assert(is_env(e));    
    if(first)
      first = TBfalse;
    else
      printn_wish(" ", 1);
    printn_wish("\{", 1);
    ftxt = get_txt(env_sym(e));
    printn_wish(ftxt, strlen(ftxt));
    printn_wish(" ", 1);
    pr_term_wish(env_val(e));
    printn_wish("\}",1);
  \}
  printn_wish("\}", 1);
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{30}\nwdocspar

%}}}

%{{{ term *TclString2Term(char *str)

\nwenddocs{}\nwbegincode{31}\sublabel{NWtclI-TclE-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-TclE-1}}}\moddef{TclString2Term~{\nwtagstyle{}\subpageref{NWtclI-TclE-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup

term *TclString2Term(char *str)
\{
  return TBmake(str);
\}

\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{32}\nwdocspar

%}}}


%{{{ toolbus_input(ClientData data, int mask)

\nwenddocs{}\nwbegincode{33}\sublabel{NWtclI-tooD-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-tooD-1}}}\moddef{toolbus_input~{\nwtagstyle{}\subpageref{NWtclI-tooD-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
void toolbus_input(ClientData data, int mask)
\{
  if(TBpeek())
    TBreceive();
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{34}\nwdocspar

%}}}

%{{{ term *from_toolbus(term *t)

\nwenddocs{}\nwbegincode{35}\sublabel{NWtclI-froC-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-froC-1}}}\moddef{from_toolbus~{\nwtagstyle{}\subpageref{NWtclI-froC-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
term *from_toolbus(term *t) 
\{
  char *fname;
  term *farg, *fargs, *event, *msg;
  int i, pid1, pid2;
  term *Env, *Subs, *Notes, *AtArgs, *Coords;
  char *AtFun;
  term *pe;
  char *mon_point;
 
  reset_buffer();
  if(TBmatch(t, "rec-do(%f(%l))", &fname, &fargs)) \{
    printb_str(fname);
    for( ; fargs; fargs = next(fargs)) \{
      printb_char(' ');
      pr_term_wish(first(fargs));
    \}      
    
    /*TBprintf(stderr, "calling function %s.\\n", BUF); */
    Tcl_Eval(interp, BUF);

    return NULL;
  \}
  
  if(TBmatch(t, "rec-eval(%f(%l))", &fname, &fargs)) \{
    /*TBprintf(stderr, "returning result of function %s: %l\\n", fname, fargs);*/
    printb_str(fname);
    for( ; fargs; fargs = next(fargs)) \{
       printb_char(' ');
       pr_term_wish(first(fargs));
    \}    

    if(interp->result)
      return TclString2Term(interp->result);

    return NULL;
  \}

  if(TBmatch(t, "rec-ack-event(%t)", &event)) \{
    /*TBprintf(stderr, "rec-ack-event %t\\n", event);*/
    printb_str("rec-ack-event ");
    pr_term_wish(event);
    /*TBprintf(stderr, "calling function %s\\n", BUF); */
    Tcl_Eval(interp, BUF);

    return NULL;
  \}

  if(TBmatch(t, "rec-monitor(%f(%d,%f,%t,%t,%t,%t,%t,%d,%t))",
        &mon_point, &pid1, &AtFun, &AtArgs, &Coords, 
        &Env, &Subs, &Notes, &pid2, &pe)) \{
    TBmsg("Monitor commands not implemented yet: %t\\n", t);
    return NULL;
  \}

  if(TBmatch(t, "rec-terminate(%t)", &msg)) \{
    printb_str("rec-terminate ");
    pr_term_wish(msg);
    Tcl_Eval(interp, BUF);

    TBexit(0);
  \}

  TBmsg("Ignored: %t\\n", t);
  return NULL;
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{36}\nwdocspar

%}}}

%{{{ int Tcl_TBsend(ClientData data, Tcl_Interp *interp, int argc, char *argv[])

\nwenddocs{}\nwbegincode{37}\sublabel{NWtclI-TclA-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-TclA-1}}}\moddef{Tcl_TBsend~{\nwtagstyle{}\subpageref{NWtclI-TclA-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
int Tcl_TBsend(ClientData data, Tcl_Interp *interp, int argc, char *argv[])
\{
  term *t;

  if(argc != 2) \{
    interp->result = "Usage: TBsend ?term?";
    return TCL_ERROR;
  \}

  t = TclString2Term(argv[1]);

  TBsend(t);
  return TCL_OK;
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{38}\nwdocspar

%}}}
%{{{ int Tcl_TBstring(ClientData data, Tcl_Interp *interp, int argc, char *argv[])

\nwenddocs{}\nwbegincode{39}\sublabel{NWtclI-TclC-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-TclC-1}}}\moddef{Tcl_TBstring~{\nwtagstyle{}\subpageref{NWtclI-TclC-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
int Tcl_TBstring(ClientData data, Tcl_Interp *interp, int argc, char *argv[])
\{
  char *buf,*src,*dest,size;

  if(argc != 2) \{
    interp->result = "Usage: TBstring ?string?";
    return TCL_ERROR;
  \}

  src = argv[1];
  size = strlen(src)+3;
  while(*src) \{
    if(*src == '"')
      size++;
    src++;
  \}
  buf = malloc(size);
  src = argv[1];
  buf[0] = '"';
  dest = buf+1;
  while(*src) \{
    if(*src == '"')
      *dest++ = '\\\\';
    *dest++ = *src++;
  \}
  *dest++ = '"';
  *dest = '\\0';
  
  Tcl_SetResult(interp, buf, TCL_DYNAMIC);
  return TCL_OK;
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{40}\nwdocspar

%}}}


%{{{ void Tcl_AppInit(Tcl_Interp *interp)

\nwenddocs{}\nwbegincode{41}\sublabel{NWtclI-TclB-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-TclB-1}}}\moddef{Tcl_AppInit~{\nwtagstyle{}\subpageref{NWtclI-TclB-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
int Tcl_AppInit(Tcl_Interp *interp)
\{
  fprintf(stderr, "Starting Tcl/Tk...\\n");
  if(Tcl_Init(interp) == TCL_ERROR) \{
    return TCL_ERROR;
  \}

  if(Tk_Init(interp) == TCL_ERROR) \{
    return TCL_ERROR;
  \}

  Tcl_CreateCommand(interp, "TBsend", Tcl_TBsend, (ClientData)NULL, (Tcl_CmdDeleteProc *)NULL);
  Tcl_CreateCommand(interp, "TBstring", Tcl_TBstring, (ClientData)NULL, (Tcl_CmdDeleteProc *)NULL);

  return TCL_OK;
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{42}\nwdocspar

%}}}
%{{{ void handle_args(int argc, char *argv[])

Analyze the executables arguments, and extract any arguments
that are interesting for the Tcl/Tk adapter or the Tcl/Tk script.

\nwenddocs{}\nwbegincode{43}\sublabel{NWtclI-hanB-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-hanB-1}}}\moddef{handle_args~{\nwtagstyle{}\subpageref{NWtclI-hanB-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
void handle_args(int argc, char *argv[])
\{
  int i;

  for(i=0; argv[i]; i++) \{
    if(streq(argv[i], "-script")) \{
      script = argv[++i];
      continue;
    \}
    if(streq(argv[i], "-name")) \{
      name = argv[++i];
      continue;
    \}
    if(streq(argv[i], "-bufsize")) \{
      bufsize = atoi(argv[++i]);
      if(bufsize <= 0) \{
        TBprintf(stderr, "warning: illegal buffer size %d\\n", bufsize);
        bufsize = DEFAULT_BUF_SIZE;
      \}
    \}
  \}
  if(!name)
    name = script;

  if(!name)
    name = "noname";
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}\nwbegindocs{44}\nwdocspar

%}}}
%{{{ int main(int argc, char *argv[])

\nwenddocs{}\nwbegincode{45}\sublabel{NWtclI-mai4-1}\nwmargintag{{\nwtagstyle{}\subpageref{NWtclI-mai4-1}}}\moddef{main~{\nwtagstyle{}\subpageref{NWtclI-mai4-1}}}\endmoddef\let\nwnotused=\nwoutput{}\nwstartdeflinemarkup\nwusesondefline{\\{NWtclI-tclG-1}}\nwenddeflinemarkup
int main(int argc, char *argv[])
\{
  Tk_Window main_win;
  int i, error;

  handle_args(argc, argv);
  BUF = malloc(bufsize);
  if(!BUF) \{
    TBprintf(stderr, "Not enough space to allocate text buffer!\\n");
    TBexit(1);
  \}

  TBinit(NULL, argc, argv, from_toolbus, NULL);

  interp = Tcl_CreateInterp();
  main_win = Tk_CreateMainWindow(interp, getenv("DISPLAY"), name, "Tk");
  if(main_win == NULL) \{
    TBprintf(stderr, "%s\\n", interp->result);
    TBexit(1);
  \}
  Tk_GeometryRequest(main_win, 200, 200);

  Tcl_AppInit(interp);

  if(script) \{
    error = Tcl_EvalFile(interp, script);
 
    if(error != TCL_OK) \{
      char *trace;

      TBprintf(stderr, "%s: %s\\n", script, interp->result);
      trace = Tcl_GetVar(interp, "errorInfo", 0);
      if(trace) \{
        TBprintf(stderr, "***** TCL TRACE *****\\n");
        TBprintf(stderr, "%s\\n", trace);
      \}
    \}
  \}

  /* Install handler */
  TBprintf(stderr, "%d ports\\n", ninports);
  for(i=0; i<ninports; i++) \{
    TBprintf(stderr, "Adding port %d (%d)\\n", i, inportset[i].in);
    Tk_CreateFileHandler(inportset[i].in, TK_READABLE, toolbus_input, NULL);
  \}  
  
  while(1) \{
    Tk_DoOneEvent(TK_ALL_EVENTS);
  \}
  return 0;                   /* Needed only to prevent compiler warning. */
\}
\nwused{\\{NWtclI-tclG-1}}\nwendcode{}

\nwixlogsorted{c}{{from_toolbus}{NWtclI-froC-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-froC-1}}}%
\nwixlogsorted{c}{{functions}{NWtclI-fun9-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-fun9-1}}}%
\nwixlogsorted{c}{{handle_args}{NWtclI-hanB-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-hanB-1}}}%
\nwixlogsorted{c}{{includes}{NWtclI-inc8-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-inc8-1}}}%
\nwixlogsorted{c}{{main}{NWtclI-mai4-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-mai4-1}}}%
\nwixlogsorted{c}{{pr_env_wish}{NWtclI-pr*B-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-pr*B-1}}}%
\nwixlogsorted{c}{{printb_char}{NWtclI-priB-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-priB-1}}}%
\nwixlogsorted{c}{{printb_str}{NWtclI-priA-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-priA-1}}}%
\nwixlogsorted{c}{{print_escaped_char}{NWtclI-priI-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-priI-1}}}%
\nwixlogsorted{c}{{printn_wish}{NWtclI-priB.2-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-priB.2-1}}}%
\nwixlogsorted{c}{{pr_string_wish}{NWtclI-pr*E-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-pr*E-1}}}%
\nwixlogsorted{c}{{pr_term_list_wish}{NWtclI-pr*H-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-pr*H-1}}}%
\nwixlogsorted{c}{{pr_term_wish}{NWtclI-pr*C-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-pr*C-1}}}%
\nwixlogsorted{c}{{pr_type_wish}{NWtclI-pr*C.2-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-pr*C.2-1}}}%
\nwixlogsorted{c}{{reset_buffer}{NWtclI-resC-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-resC-1}}}%
\nwixlogsorted{c}{{Tcl_AppInit}{NWtclI-TclB-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-TclB-1}}}%
\nwixlogsorted{c}{{TclString2Term}{NWtclI-TclE-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-TclE-1}}}%
\nwixlogsorted{c}{{Tcl_TBsend}{NWtclI-TclA-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-TclA-1}}}%
\nwixlogsorted{c}{{Tcl_TBstring}{NWtclI-TclC-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-TclC-1}}}%
\nwixlogsorted{c}{{tcltk-adapter.c*}{NWtclI-tclG-1}{\nwixd{NWtclI-tclG-1}}}%
\nwixlogsorted{c}{{toolbus_input}{NWtclI-tooD-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-tooD-1}}}%
\nwixlogsorted{c}{{variables}{NWtclI-var9-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-var9-1}}}%
\nwixlogsorted{c}{{wish_type_string}{NWtclI-wisG-1}{\nwixu{NWtclI-tclG-1}\nwixd{NWtclI-wisG-1}}}%
\nwbegindocs{46}\nwdocspar

%}}}

\nwenddocs{}

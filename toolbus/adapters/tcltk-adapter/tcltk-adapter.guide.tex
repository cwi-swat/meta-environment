%%
%%    ToolBus -- The ToolBus Application Architecture
%%    Copyright (C) 1998-2000  Stichting Mathematisch Centrum, Amsterdam, 
%%                             The  Netherlands.
%%
%%    This program is free software; you can redistribute it and/or modify
%%    it under the terms of the GNU General Public License as published by
%%    the Free Software Foundation; either version 2 of the License, or
%%    (at your option) any later version.
%%
%%    This program is distributed in the hope that it will be useful,
%%    but WITHOUT ANY WARRANTY; without even the implied warranty of
%%    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
%%    GNU General Public License for more details.
%%
%%    You should have received a copy of the GNU General Public License
%%    along with this program; if not, write to the Free Software
%%    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
%%

\section{\label{ToolsInTcl2}Writing tools in Tcl/Tk}

Besides the wish-adapter, there is a second, more efficient but also
less flexible way to connect tools written in Tcl/Tk to the Toolbus.
When the ToolBus distribution has been configured using the option
{\tt --with-tcltk=<tcl/tk-basepath>}, the {\tt tcltk-adapter} is build.
In contrast with the wish-adapter, this adapter is completely integrated 
with a tcl/tk interpreter. This eliminates the piped communication between
the wish-adapter and the wish interpreter (see Figure \ref{tcltk-adapters}.

\begin{figure}[htb]
  \centerline{\psfig{figure=tcltk-adapter/adapters.ps,width=13cm,height=8cm}}
  \caption{\label{tcltk-adapters}The wish-adapter and the tcltk-adapter}
\end{figure}
 

\subsection{\label{tcltk-adapter}{\tt tcltk-adapter}}

\paragraph{Synopsis.} Execute Tcl/Tk's windowing shell {\tt wish} as a tool.

\paragraph{Example.} {\tt tcltk-adapter -script calculator.tcl}

\paragraph{Specific arguments.}
\begin{itemize}
\item {\tt -wish \emp{Name}}: Use \emp{Name} rather than {\tt wish} as Tcl/Tk's windowing shell.
\item {\tt -lazy-exec}: Postpone execution of {\tt wish} until needed.
\item {\tt -script}: The Tcl script to be executed.
\item {\tt -script-args}: The arguments for the Tcl script to be executed.
      These arguments are available to the Tcl script throught the variables
      {\tt argc} and {\tt argv}.
\end{itemize}

\paragraph{Communication.} \hspace{-0.3cm}\footnote{Communication is described
from the point of view of the \TB, i.e., {\tt snd-} and {\tt rec-}
mean, respectively, send by \TB\ and receive by \TB.}

\begin{itemize}
\item {\tt snd-do($Tid$, $Fun$($A_1$, ..., $A_n$))}: perform the Tcl function
call
{\tt $Fun$ $A_1$  ... $A_n$}. Here $Tid$ is a tool identifier
(as produced by {\tt execute} or {\tt rec-connect}) for an instance of the {\tt
wish-adapter}.
\item {\tt snd-eval($Tid$, $Fun$($A_1$, ..., $A_n$))}: perform the Tcl function call
{\tt $Fun$ $A_1$  ... $A_n$}. Here $Tid$ is a tool identifier 
(as produced by {\tt execute} or {\tt rec-connect}) for an instance of the {\tt wish-adapter}.
Note that the function {\tt $Fun$} must send an anser back to the
ToolBus (using {\tt TBsend "snd-eval(...)"}).
\item {\tt rec-value($Tid$,$Res$)}: the return value for a previous evaluation request.
\item {\tt rec-event($Tid$, $A_1$, ..., $A_n$)}: event generated by wish.
\item {\tt snd-ack-event($Tid$, $A_1$)}: acknowledgement of
a previously generated event.
\item {\tt snd-terminate($Tid$, $A_1$)}: terminate execution of wish-adapter.
\item \txttt{snd-monitor(\emp{Trm})}: in this case the Tcl
  function \txttt{monitor\_atom \{\emp{ProcId} \emp{AtFun},
    \emp{Src} \emp{Blino} \emp{Bpos} \emp{Elino} \emp{Epos}\}}
  is called where \emp{ProcId} is the process-id of the process to
  which this atom belongs, \emp{AtFun} is the action function name of
  the atom (printf, tau, snd-do, snd-eval, rec-msg etc.), \emp{Src} the
  source file where the atom is defined, \emp{Blino} the number of
  the line where the atom starts, \emp{Bpos} the column of the
  line where the atom starts, \emp{Elino} the number of the line
  where the atom ends and \emp{Epos} is the column of the line where
  the atom ends (this information can be used for example for
  highlightning a piece of source code). 
  After calling this function the term is further analyzed,
  possibly resulting in (several) other Tcl function
  calls. The following situations are considered:
  \begin{itemize}
  \item \emp{process creation}:
    \txttt{create\_proc \{\emp{ProcId} \emp{ProcName}\}} is
    called.
  \item \emp{tool creation}: \txttt{create\_tool \{\emp{ToolId}
      \emp{ToolName}\}} is called.
  \item \emp{process to tool communication}:
    \txttt{proc\_tool\_comm \{\emp{ToolId} \emp{ProcId}\}} is
    called.
  \item \emp{tool to process communication}:
    \txttt{tool\_proc\_comm \{\emp{ProcId} \emp{ToolId}\}} is
    called.
  \item \emp{process to process communication}:
    \txttt{proc\_proc\_comm \{\emp{ProcId1} \emp{ProcId2}\}} is
    called.
  \item \emp{update the value of a variable in a process}:
    \txttt{update\_var \{\emp{ProcId} \emp{VarName}
      \emp{NewValue}\}} is called.
  \item \emp{update the list of subscribtions of a process}:
    \txttt{update\_subs \{\emp{ProcId} \emp{Subs}\}} is called.
  \item \emp{update the list of notes of a process}:
    \txttt{update\_notes \{\emp{ProcId} \emp{Notes}\}} is called.
  \end{itemize}
\end{itemize}

\noindent The command {\tt wish} is executed once, an initial Tcl script
is read, and all further requests are directed to this incarnation
of {\tt wish}. A small set of Tcl procedures is available for
unpacking and packing \TB\ terms (see below).

\subsection{\label{TclTk-functions}Predefined Tcl functions}
The following Tcl functions are predefined and can be used freely in Tcl
script executed via the wish-adapter:
\begin{itemize}
\item {\tt TBstring $Str$\/}: converts a Tcl string to a \TB\ string by
surrounding it with double quotes and escaping double quotes occurring
inside $Str$.

\item {\tt TCLstring $Str$\/}: converts a \TB\ string into  a Tcl string
by removing surrounding double quotes.

\item {\tt TBlist $List$\/}: converts a Tcl list to a \TB\ list by
separating the elements with commas and surrounding the list by
curly braces.

\item {\tt TBerror $Msg$\/}: constructs an error message that can be sent
to the \TB.

\item {\tt TBsend $Trm$\/}: send $Trm$ back to the \TB.

\item {\tt TBevent $Event$\/}: send event $Event$ to the \TB.

\item {\tt TBrequire $ToolName$ $ProcName$ $Nargs$} check
that the Tcl code for $ToolName$ contains a procedure declaration
for $ProcName$ with $Nargs$ formal parameters.
This function is mainly used by the {\tt wish-adapter} to check
compatibility of the Tcl code with the expected input
signature of the tool.
\end{itemize}

\paragraph{Note.} All communication between wish-adapter and a
 tool written in Tcl is done via standard input/output. {\bf Only use
the standard error stream for print statements in the Tcl script,
since using standard output will disrupt the communication with the
\TB}.

\subsection{\label{Ex-hello2.tcl}The hello example in tcl: {\tt hello.tcl}}

Writing the hello tool in Tcl requires two steps:
\begin{itemize}
\item Write the required Tcl code {\tt hello.tcl}. The result is shown in Figure~\ref{fig:hello.tcl}.
\item Replace {\tt hello}'s tool definition in {\tt hello2.tb} by:
\begin{verbatim}
      tool hello is {command = "tcltk-adapter -script hello.tcl"}
\end{verbatim}
\end{itemize}

# @configure_input@
# directory: tide

PRODUCT         = @PRODUCT@
VERSION         = @VERSION@

SHELL           = /bin/sh
srcdir          = @srcdir@
VPATH           = @srcdir@
top_srcdir      = @top_srcdir@

CC              = @CC@
CFLAGS          = -g @CFLAGS@
CPP             = @CPP@
CPPFLAGS        = @CPPFLAGS@
DEFS            = @DEFS@ -DVERSION="\"$(VERSION)\""
LIBS            = @LIBS@
SHARED_TB_LIB   = @SHARED_TB_LIB@
MODULES         = @MODULES@

AR              = @AR@
RANLIB          = @RANLIB@
INSTALL         = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
LEX             = @LEX@
LEXLIB          = @LEXLIB@
YACC            = @YACC@
YACCLIB         = @YACCLIB@
CLEAN           = @CLEAN@
@SET_MAKE@

NOWEB		= @NOWEB@
TIDEDEF		= @TIDEDEF@

prefix          = @prefix@
exec_prefix     = @exec_prefix@
bindir		= @bindir@
libdir		= @libdir@
datadir		= @datadir@
tidedir		= $(datadir)/tide
bitmapdir	= $(datadir)/bitmaps
includedir      = @includedir@

TOOLBUS		= @top_srcdir@/src/toolbus
CTIF		= @top_srcdir@/src/ctif

COMPILE = $(CC) -c $< $(DEFS) $(INCLUDE) $(CPPFLAGS) $(CFLAGS)
LINK = $(CC) $(LDFLAGS) $(LIB) -o $@

INCLUDE	= -I$(top_srcdir)/src -I$(srcdir) -I$(includedir)
LIB	= -L$(top_srcdir)/src -L$(top_srcdir)/tide

PROGS	= buscontrol
LIBFILES= libtide.a 
TIDEFILES= tide.tb $(GENTCL)
INCFILES= tide.h dap-admin.h dap.h
NWSRC	= buscontrol.c.nw dap.c.nw dap-admin.c.nw \
	source-viewer.tcl.nw process-viewer.tcl.nw \
	rule-viewer.tcl.nw tide-modules.tcl.nw tide.tb.nw \
	watchpoint-viewer.tcl.nw
TIDEMODS= dap.o dap-admin.o
TCLMODS	= tide-modules.tcl tide-daps.tcl tide-processes.tcl \
	tide-event-rules.tcl tide-cpe.tcl \
	tide-exec-state.tcl tide-exec-control.tcl tide-current-port.tcl \
	tide-ui-process-list.tcl tide-ui-rule-list.tcl
GENCSRC	= buscontrol.c dap.c dap-admin.c
GENCHDR	= viewer.tif.c debug-adapter.tif.c dap-admin.h dap.h
GENTCL	= source-viewer.tcl process-viewer.tcl \
	rule-viewer.tcl watchpoint-viewer.tcl \
	$(TCLMODS)
GENTEX	= buscontrol.c.tex \
	source-viewer.tcl.tex process-viewer.tcl.tex \
	tide.tb.tex rule-viewer.tcl.tex tide-modules.tcl.tex \
	watchpoint-viewer.tcl.tex
DIRS	= bitmaps test help
BITMAPS	= run-until-parent.xbm run.xbm single-step.xbm step-over.xbm step.xbm \
	stop.xbm unknown.xbm selected.xbm unselected.xbm

DISTFILES = $(NWSRC) $(GENCSRC) $(GENCHDR) $(GENTCL) $(GENTEX) \
	$(DIRS) tide.in slave-example.tb tide.tb tide.h Makefile.in

all:  $(LIBFILES) $(PROGS) $(GENSRC) $(TCLMODS) $(GENTCL)

# Implicit dependencies
%.tcl: %.tcl.nw
	$(NOWEB) $<
	touch $*.tcl $*.tcl.tex

%.tcl.tex: %.tcl.nw
	$(NOWEB) $<
	touch $*.tcl.tex

%.c: %.c.nw
	$(NOWEB) $<
	touch $*.h $@ $@.tex

%.c.tex: %.c.nw
	$(NOWEB) $<
	touch $@.tex

%.h: %.c.nw
	$(NOWEB) $<
	touch $*.h $@ $@.tex

%.o: %.c
	$(COMPILE)

%.tifs: %.tb
	$(TOOLBUS) -gentifs $<

# Explicit dependencies
tide.tb: tide.tb.nw
	$(NOWEB) tide.tb.nw
	touch tide.tb tide.tb.tex

tide.tb.tex: tide.tb.nw
	$(NOWEB) tide.tb.nw
	touch tide.tb.tex

debug-adapter.tif.c: tide.tifs
	$(CTIF) -multi -tool debug-adapter -tifs tide.tifs

viewer.tif.c: slave-example.tifs
	$(CTIF) -multi -tool viewer -tifs slave-example.tifs

buscontrol: buscontrol.o
	$(LINK) buscontrol.o -ltide -ltb $(LIBS)

libtide.a: $(TIDEMODS)
	ar cr libtide.a $(TIDEMODS)

# Calculate C dependencies
depend: $(GENCSRC)
	$(CC) -MM $(DEFS) $(INCLUDE) $(CPPFLAGS) $(CFLAGS) $(GENCSRC) > .depend

# Keep track of some size statistics
stats:
	date >> .noweb-stats
	wc -l $(NWSRC) >> .noweb-stats
	date >> .source-stats
	wc -l Makefile tide.tb $(tcl) $(GENCSRC) >> .source-stats
	date >> .code-stats
	ls -al buscontrol >> .code-stats

# tifs dependencies
tide.tifs: tide.tb
slave-example.tifs: slave-example.tb

# Noweb dependencies
source-viewer.tcl: source-viewer.tcl.nw
rule-viewer.tcl: rule-viewer.tcl.nw
watchpoint-viewer.tcl: watchpoint-viewer.tcl.nw
process-viewer.tcl: process-viewer.tcl.nw
buscontrol.c buscontrol.c.tex: buscontrol.c.nw
dap.c: dap.c.nw
dap.h: dap.c.nw
dap-admin.c: dap-admin.c.nw
dap-admin.h: dap-admin.c.nw

# Tcl modules
tide-support.tcl: tide-modules.tcl.nw
	$(NOWEB) tide-modules.tcl.nw
	touch $@

tide-daps.tcl: tide-modules.tcl.nw
	$(NOWEB) tide-modules.tcl.nw
	touch $@

tide-processes.tcl: tide-modules.tcl.nw
	$(NOWEB) tide-modules.tcl.nw
	touch $@

tide-event-rules.tcl: tide-modules.tcl.nw
	$(NOWEB) tide-modules.tcl.nw
	touch $@

tide-cpe.tcl: tide-modules.tcl.nw
	$(NOWEB) tide-modules.tcl.nw
	touch $@

tide-exec-state.tcl: tide-modules.tcl.nw
	$(NOWEB) tide-modules.tcl.nw
	touch $@

tide-exec-control.tcl: tide-modules.tcl.nw
	$(NOWEB) tide-modules.tcl.nw
	touch $@

tide-current-port.tcl: tide-modules.tcl.nw
	$(NOWEB) tide-modules.tcl.nw
	touch $@

tide-ui-rule-list.tcl: tide-modules.tcl.nw
	$(NOWEB) tide-modules.tcl.nw
	touch $@

# C dependencies
buscontrol.o: buscontrol.c dap.h dap-admin.h viewer.tif.c debug-adapter.tif.c
dap-admin.o: dap-admin.c dap-admin.h
dap.o: dap.c dap.h dap-admin.h

# clean
clean:
	${CLEAN} $(PROGS) $(TIDEMODS) *~

distclean: clean
	rm -f Makefile

# dist
dist: $(DISTFILES)
	@for file in $(DISTFILES); do \
	  ln $(srcdir)/$$file ../../$(PRODUCT)-$(VERSION)/tide 2> /dev/null \
	  || cp -r $(srcdir)/$$file ../../$(PRODUCT)-$(VERSION)/tide; \
	done

# install
install: $(LIBFILES) $(TIDEFILES) $(PROGS) $(INCFILES)
	for file in $(PROGS) tide; do \
	  $(INSTALL) $$file $(bindir); \
	done
	for file in $(LIBFILES); do \
	  $(INSTALL) $$file $(libdir); \
	done
	for file in $(TIDEFILES); do \
	  $(INSTALL) $$file $(tidedir); \
	done  
	for file in $(BITMAPS); do \
	  $(INSTALL) bitmaps/$$file $(bitmapdir); \
	done
	for file in $(INCFILES); do \
	  $(INSTALL) $$file $(includedir); \
	done
 

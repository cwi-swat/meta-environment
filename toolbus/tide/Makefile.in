# @configure_input@
# directory: tide

PRODUCT         = @PRODUCT@
VERSION         = @VERSION@

SHELL           = /bin/sh
srcdir          = @srcdir@
VPATH           = @srcdir@
top_srcdir      = @top_srcdir@

CC              = @CC@
CFLAGS          = -g @CFLAGS@
CPP             = @CPP@
CPPFLAGS        = @CPPFLAGS@
DEFS            = @DEFS@ -DVERSION="\"$(VERSION)\""
LIBS            = @LIBS@
SHARED_TB_LIB   = @SHARED_TB_LIB@
MODULES         = @MODULES@

AR              = @AR@
RANLIB          = @RANLIB@
INSTALL         = @INSTALL@
INSTALL_PROGRAM = @INSTALL_PROGRAM@
LEX             = @LEX@
LEXLIB          = @LEXLIB@
YACC            = @YACC@
YACCLIB         = @YACCLIB@
CLEAN           = @CLEAN@
@SET_MAKE@

NOWEB		= @NOWEB@
TIDEDEF		= @TIDEDEF@

prefix          = @prefix@
exec_prefix     = @exec_prefix@
bindir          = $(exec_prefix)/bin
libdir          = $(exec_prefix)/lib
includedir      = $(prefix)/include

TOOLBUS		= @top_srcdir@/src/toolbus
CTIF		= @top_srcdir@/src/ctif

COMPILE = $(CC) -c $< $(DEFS) $(INCLUDE) $(CPPFLAGS) $(CFLAGS)
LINK = $(CC) $(LDFLAGS) $(LIB) -o $@

INCLUDE	= -I$(top_srcdir)/src -I$(srcdir)
LIB	= -L$(top_srcdir)/src -L$(top_srcdir)/tide

PROGS	= buscontrol synthesizer
LIBFILES= tide.tb libtide.a
INCFILES= tide.h dap-util.h admin.h admin-daps.h
NWSRC	= buscontrol.c.nw synthesizer.c.nw dap-util.c.nw admin.c.nw \
	source-browser.tcl.nw process-viewer.tcl.nw master-control.tcl.nw \
	opoint-viewer.tcl.nw tide-modules.tcl.nw tide.tb.nw \
	watchpoint-viewer.tcl.nw
TIDEMODS= dap-util.o admin.o admin-daps.o
TCLMODS	= tide-modules.tcl tide-daps.tcl tide-processes.tcl \
	tide-observation-points.tcl tide-cpe.tcl \
	tide-exec-state.tcl tide-exec-control.tcl tide-current-port.tcl
GENCSRC	= buscontrol.c synthesizer.c dap-util.c
GENCHDR	= viewer.tif.c synthesizer.tif.c debug-adapter.tif.c dap-util.h
GENTCL	= source-browser.tcl process-viewer.tcl master-control.tcl \
	opoint-viewer.tcl watchpoint-viewer.tcl $(TCLMODS)
GENTEX	= buscontrol.c.tex synthesizer.c.tex \
	source-browser.tcl.tex process-viewer.tcl.tex master-control.tcl.tex \
	tide.tb.tex opoint-viewer.tcl.tex tide-modules.tcl.tex \
	watchpoint-viewer.tcl.tex
DIRS	= bitmaps test help

DISTFILES = $(NWSRC) $(GENCSRC) $(GENCHDR) $(GENTCL) $(GENTEX) \
	$(DIRS) slave-example.tb tide.tb tide.h Makefile.in

.SUFFIXES:
.SUFFIXES: .c.nw .c .h .o .tcl.nw .tcl .tex .tb .tifs

all:  $(LIBFILES) $(PROGS) $(GENSRC) $(TCLMODS) $(GENTCL)

# Implicit dependencies
.tcl.nw.tcl:
	$(NOWEB) $<
	touch $*.tcl $*.tcl.tex

.c.nw.c:
	$(NOWEB) $<
	touch $*.h $@ $@.tex

.c.nw.h:
	$(NOWEB) $<
	touch $*.h $@ $@.tex

.c.o:
	$(COMPILE)

# Explicit dependencies
tide.tb: tide.tb.nw
	$(NOWEB) tide.tb.nw
	touch tide.tb tide.tb.tex

.tb.tifs:
	$(TOOLBUS) -gentifs $<

debug-adapter.tif.c: tide.tifs
	$(CTIF) -newstyle -tool debug-adapter -tifs tide.tifs

viewer.tif.c: slave-example.tifs
	$(CTIF) -newstyle -tool viewer -tifs slave-example.tifs

synthesizer.tif.c: tide.tifs
	$(CTIF) -newstyle -tool synthesizer -tifs tide.tifs

buscontrol: buscontrol.o
	$(LINK) buscontrol.o -ltb $(LIBS)

synthesizer: synthesizer.o
	$(LINK) synthesizer.o -ltb $(LIBS)

libtide.a: $(TIDEMODS)
	ar cr libtide.a $(TIDEMODS)

# Calculate C dependencies
depend: $(GENCSRC)
	$(CC) -MM $(DEFS) $(INCLUDE) $(CPPFLAGS) $(CFLAGS) $(GENCSRC) > .depend

# Keep track of some size statistics
stats:
	date >> .noweb-stats
	wc -l $(NWSRC) >> .noweb-stats
	date >> .source-stats
	wc -l Makefile tide.tb $(tcl) $(GENCSRC) >> .source-stats
	date >> .code-stats
	ls -al buscontrol >> .code-stats

# tifs dependencies
tide.tifs: tide.tb
slave-example.tifs: slave-example.tb

# Noweb dependencies
source-browser.tcl: source-browser.tcl.nw
opoint-viewer.tcl: opoint-viewer.tcl.nw
watchpoint-viewer.tcl: watchpoint-viewer.tcl.nw
process-viewer.tcl: process-viewer.tcl.nw
master-control.tcl: master-control.tcl.nw
buscontrol.c: buscontrol.c.nw
synthesizer.c: synthesizer.c.nw
dap-util.c: dap-util.c.nw
dap-util.h: dap-util.c.nw
admin.c: admin.c.nw
admin.h: admin.c.nw
admin-daps.c: admin.c.nw
admin-daps.h: admin.c.nw

# Tcl modules
tide-support.tcl: tide-modules.tcl.nw
tide-daps.tcl: tide-modules.tcl.nw
tide-processes.tcl: tide-modules.tcl.nw
tide-observation-points.tcl: tide-modules.tcl.nw
tide-cpe.tcl: tide-modules.tcl.nw
tide-exec-state.tcl: tide-modules.tcl.nw
tide-exec-control.tcl: tide-modules.tcl.nw
tide-current-port.tcl: tide-modules.tcl.nw

# C dependencies
buscontrol.o: buscontrol.c viewer.tif.c debug-adapter.tif.c
dap-util.o: dap-util.c dap-util.h
admin.o: admin.h admin.c
admin-daps.o: admin-daps.c admin-daps.h admin.h

# clean
clean:
	${CLEAN} $(PROGS) $(TIDEMODS) *~

distclean: clean
	rm -f Makefile

# dist
dist: $(DISTFILES)
	@for file in $(DISTFILES); do \
	  ln $(srcdir)/$$file ../../$(PRODUCT)-$(VERSION)/tide 2> /dev/null \
	  || cp -r $(srcdir)/$$file ../../$(PRODUCT)-$(VERSION)/tide; \
	done

# install
install: $(LIBFILES)
	for file in $(LIBFILES); do \
	  $(INSTALL) $$file $(libdir); \
	done  
	for file in $(INCFILES); do \
	  $(INSTALL) $$file $(includedir); \
	done
 

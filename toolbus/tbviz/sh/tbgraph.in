#! /bin/sh
#
# $Id$
#
prefix=@prefix@
CTASDF="ctasdf 100"

TESTDIR="/tmp/tbgraph-$$"

SPECDIR="@exec_prefix@/spec/tbviz"


THISTEST="tbgraph-$$"
TESTIN="$TESTDIR/$THISTEST.input"
#TESTOUT="$TESTDIR/$THISTEST.output"
#TESTRES="$TESTDIR/$THISTEST.result"
#TESTGAR="$TESTDIR/$THISTEST.garbage"

startdir=`pwd`

mkdir $TESTDIR

tbfile=$1
ppfile=$tbfile.pp
dotfile=$ppfile.dot
psfile=$tbfile.ps

echo "Preprocessing tb file"
cc -E $tbfile > $TESTDIR/$ppfile

(
  # work around for bug in ascii interface ..
  echo "(loadfile \""$HOME/.centaur"\" t)"

  echo "(setq {UI}:output-file (concat \""$TESTGAR"\"))"
  echo "(setq {UI}:output-fp (outchan))"
  echo "(setq {UI}:old-output-fp (outchan))"
  echo ";; To make sure the buttons work OK for the ASCII interface as well."
  echo "(de {EDITING}:editing:ascii:gse-inst (ed) ed)"
  echo "(de {EDITING}:ascii:MM (ed) ed)"
  echo "(de {EDITING}:editing:ascii:vtptrees (ed) ())"

  echo "(ascii-asdf)"

# Add the following lines if your ctasdf.conf does not load
# the stuff automatically.
#  echo "Specification"
#  echo "Add"
#  echo "."
#  echo Copy-Top
#  echo "yes"

  	echo "Edit-term"
  	echo Tscript
	echo $TESTDIR
  	echo $ppfile
  	echo "yes"
  	echo "Parse"
	# Add as many button calls as you like.
        echo "Dump-Viz"
  	echo "Quit"
  echo "Specification"
  echo "Quit"
  echo "(end)"

  ) > $TESTIN

#echo "$THISTEST " `date` "."   >  $TESTGAR
#echo "$THISTEST " `date` "."   >  $TESTRES

echo "Now performing $THISTEST, some time needed for $CTASDF ..."
cd $SPECDIR
$CTASDF < $TESTIN

echo "Postprocessing..."
mv $TESTDIR/$dotfile $TESTDIR/$dotfile.pre
cat $TESTDIR/$dotfile.pre | perl @exec_prefix@/bin/postgraph > $TESTDIR/$dotfile
echo "Running dot..."
dot -Tps -Gratio=auto -Gpage="8,12" -Gmargin=".2,.2" -Nfontname=Helvetica -Efontname=Helvetica $TESTDIR/$dotfile > $startdir/$psfile

#remove stuff here 
echo "Cleaning up..."
mv $TESTDIR/$dotfile $startdir/$tbfile.dot
rm -rf $TESTDIR

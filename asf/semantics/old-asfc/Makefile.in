#
#    Meta-Environment - An environment for language prototyping.
#    Copyright (C) 2000  Stichting Mathematisch Centrum, Amsterdam, 
#                        The Netherlands. 
#
#    This program is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 2 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with this program; if not, write to the Free Software
#    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307 USA
#
# Directory: asfix2c-compiler

# Configure variable substitutions
PRODUCT		= @PRODUCT@
VERSION		= @VERSION@

@SET_MAKE@

srcdir		= @srcdir@
VPATH		= @srcdir@
top_srcdir	= @top_srcdir@
prefix		= @prefix@
exec_prefix	= @exec_prefix@
bindir		= @bindir@
libdir		= @libdir@
includedir	= $(prefix)/include
docdir		= $(top_srcdir)/docs

SHELL		= @SHELL@
MAKEDEPEND	= @MAKEDEPEND@
CC		= @CC@
CFLAGS		= -O4 ${XCFLAGS}
CPP		= @CPP@
CPPFLAGS	= @CPP@ ${XCPPFLAGS}
DEFS		= @DEFS@ ${XDEFS}
INCLUDES	= @INCLUDES@ ${XINCLUDES}
LIBS		= @LIBS@ ${XLIBS}
SOCKLIBS	= @SOCKLIBS@ 

INSTALL		= @INSTALL@
INSTALL_DATA	= @INSTALL_DATA@
INSTALL_PROG	= @INSTALL_PROG@
UNINSTALL	= @UNINSTALL@

AR		= @AR@

ATERM		= @ATERM@
ATERMBIN	= @ATERMBIN@
ATERMLIB	= @ATERMLIB@
ATERMINC	= @ATERMINC@
ASFIX		= @ASFIX@
ASFIXBIN	= @ASFIXBIN@
ASFIXLIB	= @ASFIXLIB@
ASFIXINC	= @ASFIXINC@
TOOLBUS		= @TOOLBUS@
TOOLBUSBIN	= @TOOLBUSBIN@
TOOLBUSLIB	= @TOOLBUSLIB@
TOOLBUSINC	= @TOOLBUSINC@

# Implicit rules
include ${top_srcdir}/implicit-rules 

# The eXtra parts of some variables
XCFLAGS		= -DBINDIR=\"$(bindir)\"  
XCPPFLAGS	=
XINCLUDES	= -I${top_srcdir}/asc-support -I$(ASFIXINC) -I$(ATERMINC)
XLIBS		= -L${top_srcdir}/asc-support -L$(ASFIXLIB) -lasc-support \
		  -L../compiler/c-source -lAsFix2C \
		  -L$(ATERMLIB) -lATerm -lAsFix -lATB \
		  $(SOCKLIBS)

# Other variables
# CSRC/CHDR are used to calculate dependencies.
CSRC		= asfix2c.c asfix-db.c asfix-io.c asfix-reshuffle.c
CHDR		= 
OBJ             = $(subst .c,.o,$(CSRC))        
# All files in BINFILES are installed in $(bindir)
BINFILES	= asfix2c 
# All files in LIBFILES are installed in $(libdir)
LIBFILES	=
# All files in INCLUDEFILES are installed in $(includedir)
INCLUDEFILES	= 
# All files in DOCFILES are copied to $(docdir)
DOCFILES	=

# CLEANFILES are removed by 'make clean'
CLEANFILES	= $(GENCSRC) $(GENCHDR) *.o *~ $(BINFILES)
# DISTCLEANFILES are removed by 'make distclean'
DISTCLEANFILES	= Makefile

SUBDIRS		= 

# The all target must be defined:
all: depend subdirs $(BINFILES) $(LIBFILES) $(INCLUDEFILES)

# Unit test target
test:	asfix2c-test

asfix2c-test:
	@cd regress-test; ./regress-asfix2c 

subdirs:
	@for dir in $(SUBDIRS); \
	do \
		echo "make all in $$dir"; \
		cd $$dir; ${MAKE} all; \
		cd ..; \
	done

# Explicit rules
# example: 'mytest.c: mytest.c.nw'

asfix2c: depend ${OBJ} ../compiler/c-source/libAsFix2C.a
	$(CC) -o $@ $(OBJ) $(LIBS)

%.o:    %.c     $(INCLUDEFILES)
	$(CC) $(CFLAGS) $(INCLUDES) -c $< 
##########################################################
### Everything below this line should remain unchanged ###
##########################################################

# install target (install binaries, include files, and libraries)
install: all
	mkdir -p $(bindir) $(libdir) $(includedir)
	@$(INSTALL_PROG) $(INSTALL) $(bindir) $(BINFILES)
	@$(INSTALL_DATA) $(INSTALL) $(libdir) $(LIBFILES)
	@$(INSTALL_DATA) $(INSTALL) $(includedir) $(INCLUDEFILES)

#	@for DIR in $(SUBDIRS); \
#	do \
#	   echo Make $@ in $$DIR; \
#	   cd $$DIR; \
#	   $(MAKE) $@; \
#	   cd ..; \
#	done


# uninstall target (remove all files installed by 'install' target)
uninstall:
	@$(UNINSTALL) $(bindir) $(BINFILES)
	@$(UNINSTALL) $(libdir) $(LIBFILES)
	@$(UNINSTALL) $(includedir) $(INCLUDEFILES)
	@for DIR in $(SUBDIRS); \
	do \
	   echo Make $@ in $$DIR; \
	   cd $$DIR; \
	   $(MAKE) $@; \
	   cd ..; \
	done

# doc target (copy generated documentation files to $(docdir))
doc: $(DOCFILES)
	@$(INSTALL_DATA) $(INSTALL) $(docdir) $(DOCFILES)

# clean target (remove all easily build components and temporary files)
clean:
	rm -f $(CLEANFILES)
	@for DIR in $(SUBDIRS); \
	do \
	   echo Make $@ in $$DIR; \
	   cd $$DIR; \
	   $(MAKE) $@; \
	   cd ..; \
	done

# distclean target (also remove any files created by 'configure')
distclean realclean spotless: clean
	rm -f $(DISTCLEANFILES)
	@for DIR in $(SUBDIRS); \
	do \
	   echo Make $@ in $$DIR; \
	   cd $$DIR; \
	   $(MAKE) $@; \
	   cd ..; \
	done

# Some extra dependencies, to work around problems with makedepend and
# generated (.tif.?) sources


# Updating of included dependencies
depend: $(CSRC) $(CHDR)     
	-@$(MAKEDEPEND) $(INCLUDES) $(CSRC) > $@

# Included dependencies
-include depend

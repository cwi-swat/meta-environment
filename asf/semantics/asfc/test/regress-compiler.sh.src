#!/bin/sh
#
# $Id$

Revision='$Revision$'

###
#  Some global variables, that might require occasional modification
###
verbose=0

cd `dirname $0`;
mydir=__TOP_SRCDIR__/asfc/test

RM=rm
COMPILER="__TOP_BUILDDIR__/asfc/src/asfc"
COMPARE="$mydir/codediff"

terms=$mydir/terms

###
#  Get to the real work now...
###

Warn () {
	echo $* >&2
}

Error () {
	Warn $*
	error=1
}

Abort () {
	Error $*
	exit 2
}

Notify () {
	if [ $verbose -gt 0 ] ; then
		Warn $*
	fi
}

#
## Main bit...
#

if [ $verbose -gt 0 ] ; then
	VERBOSE="-v"
else
	VERBOSE=""
fi

files=`ls $terms/*.eqs 2>/dev/null`
error=0

for file in $files
do
	base=`basename $file`
	dir=`dirname $file`
	name=`basename $base .eqs`
	out=$dir/`basename $base .eqs`.c
	if [ ! -f $out.org ] ; then
		Notify "No reference term for $base"
		continue
	fi
	if $COMPILER -c -n ${name} $VERBOSE -i $file -o $out
	then
                if $COMPARE $VERBOSE $out $out.org	> /dev/null
                then
			Notify "Regression test for valid term $base succeeded"
	                ${RM} -f $out
                        printf "."
		else
			Error "Regression test for valid term $base failed"
                fi
	else
		Abort "Error compiling $file"
	fi
done

printf "\n"

exit $error
